"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const inversify_binding_decorators_1 = require("inversify-binding-decorators");
const inversify_koa_utils_1 = require("inversify-koa-utils");
const bodyParser = require("koa-bodyparser");
const jwt = require("koa-jwt");
const log4js = require("koa-log4");
const Router = require("koa-router");
const cors = require("koa2-cors");
const _ = require("lodash");
const WebSocket = require("ws");
const defConfig = require("./config/defconfig");
const ioc_1 = require("./ioc/ioc");
const iocTracer_1 = require("./ioc/iocTracer");
const log4js_1 = require("./middlewares/logger/log4js");
const BaseResponse_1 = require("./models/BaseResponse");
const log = log4js.getLogger('GServer');
class WSServer {
    constructor(initSetting) {
        let middlewares;
        let domainName;
        // let mqSetting;
        let jwtPrivateKey;
        let jwtActive;
        let httpPort;
        let corsWhitelist;
        let log4;
        if (!_.isUndefined(initSetting)) {
            middlewares = _.isUndefined(initSetting.middlewares) ? undefined : initSetting.middlewares;
            if (_.size(middlewares) === 0) {
                middlewares = undefined;
            }
            this.serverInitOnceEvents = _.isUndefined(initSetting.iniData) ? undefined : initSetting.iniData;
            corsWhitelist = _.isUndefined(initSetting.corsWhitelist) ? undefined : initSetting.corsWhitelist;
            domainName = _.isUndefined(initSetting.domainName) ? undefined : initSetting.domainName;
            // mqSetting = _.isUndefined(initSetting.mqSetting) ? undefined : initSetting.mqSetting;
            jwtPrivateKey = _.isUndefined(initSetting.jwtPrivateKey) ?
                defConfig.jwt.privateKey : initSetting.jwtPrivateKey;
            jwtActive = _.isUndefined(initSetting.jwtActive) ? defConfig.jwt.active : initSetting.jwtActive;
            httpPort = _.isUndefined(initSetting.httpPort) ? defConfig.httpPort : initSetting.httpPort;
            log4 = _.isFunction(initSetting.log4) ? log4js_1.default : initSetting.log4;
            ioc_1.container.load(inversify_binding_decorators_1.buildProviderModule());
            if (initSetting.filtersOpen) {
                const iocTracer = new iocTracer_1.default(initSetting.filters);
                iocTracer.apply(ioc_1.container);
            }
        }
        // this.main = ORMContext.init(initSetting.pathdb, initSetting.pathBeansPath);
        // caeate DB connection
        // 還不會用到mq應該還不需要去讓他一直嘗試連線
        // if (!_.isUndefined(mqSetting)) {
        // this.main.then((result) => {
        // tslint:disable-next-line:no-null-keyword
        // return mq(null, mqSetting); // connect MQ Server
        // });
        // }
        this.main = Promise.resolve(1);
        this.main.then(() => {
            const rootRouter = new Router({
                prefix: _.isUndefined(domainName) ? '' : domainName
            });
            // create server
            const server = new inversify_koa_utils_1.InversifyKoaServer(ioc_1.container, rootRouter);
            server
                .setConfig((app) => {
                app.use(async (ctx, next) => {
                    // TODO check user auth to operate function
                    try {
                        await next();
                    }
                    catch (err) {
                        const response = new BaseResponse_1.default(err.message);
                        const statusArray = _.map(_.toString(err.status));
                        if (_.size(statusArray) === 4 &&
                            statusArray[0] in ['8', '9', '7', '6', '5', '4', '3', '2', '1', '0']) {
                            // 這邊map是因為要抓取第一個數字開頭等於9就會跑error
                            if (statusArray[0] === '9') {
                                log.error(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            else {
                                log.warn(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            response.$status = err.status;
                        }
                        else {
                            ctx.status = err.status || 500;
                            log.error(err.stack, JSON.stringify(ctx.state.user) || '');
                            response.$status = ctx.status;
                            ctx.app.emit('error', err, ctx);
                        }
                        ctx.body = response;
                    }
                })
                    .use(cors({
                    origin: (ctx) => {
                        if (_.isUndefined(corsWhitelist) ||
                            _.size(corsWhitelist) === 0) {
                            return '*';
                        }
                        else if (_.includes(corsWhitelist, ctx.header.origin)) {
                            return '*';
                        }
                        else {
                            ctx.status = 404;
                            ctx.throw(422, new Error('Not Allow Cors'));
                            return false;
                        }
                    }
                }))
                    .use(log4())
                    // .use(multer({
                    //     storage: multer.memoryStorage()
                    // }).any())
                    .use(bodyParser({
                    strict: false,
                    onerror: (err, ctx) => {
                        log.error(err);
                        ctx.throw(422, new Error('body parse error'));
                    }
                }));
                if (!_.isUndefined(middlewares) && _.size(middlewares) !== 0) {
                    _.forEach(middlewares, (middleware) => {
                        app.use(middleware);
                    });
                }
                app.use(jwt({ secret: jwtPrivateKey, passthrough: !jwtActive })
                    .unless({
                    path: _.isUndefined(initSetting.unlessPath) ? [] : initSetting.unlessPath
                }));
            })
                .setErrorConfig((app) => {
                app.use((ctx, next) => {
                    log.error(ctx.status, ctx.message, JSON.stringify(ctx.state.user) || '');
                    next();
                });
            });
            this.koaServer = server.build().listen(httpPort);
            this.wssServer = new WebSocket.Server({
                server: this.koaServer
            });
            this.wssServer.on('connection', (ws) => {
                // ws.upgradeReq是一个request对象:
                const user = ws;
                // if (!user) {
                //     // Cookie不存在或无效，直接关闭WebSocket:
                //     ws.close(4001, 'Invalid user');
                // }
                // 识别成功，把user绑定到该WebSocket对象:
                ws.user = user;
                // 绑定WebSocketServer对象:
                ws.wss = this.wssServer;
            });
            this.wssServer.on('open', function open() {
                console.log('connected');
            });
            log.info('Http started listening on http://localhost:%s ...', httpPort);
        })
            .catch((e) => {
            log.error(e);
        });
    }
    start() {
        return Promise.resolve(this.main).then(() => {
            if (!_.isUndefined(this.serverInitOnceEvents) && _.size(this.serverInitOnceEvents) !== 0) {
                _.forEach(this.serverInitOnceEvents, (element) => {
                    element.doOnce();
                    element.end();
                });
            }
            return this.wssServer;
        });
    }
}
exports.default = WSServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV1NTZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJXU1NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtFQUFtRTtBQUNuRSw2REFBeUQ7QUFFekQsNkNBQTZDO0FBQzdDLCtCQUErQjtBQUMvQixtQ0FBbUM7QUFDbkMscUNBQXFDO0FBQ3JDLGtDQUFrQztBQUNsQyw0QkFBNEI7QUFDNUIsZ0NBQWdDO0FBQ2hDLGdEQUFnRDtBQUNoRCxtQ0FBc0M7QUFDdEMsK0NBQXdDO0FBQ3hDLHdEQUFvRDtBQUNwRCx3REFBaUQ7QUFJakQsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN4QyxNQUFxQixRQUFRO0lBS3pCLFlBQVksV0FBNEI7UUFDcEMsSUFBSSxXQUFXLENBQUM7UUFDaEIsSUFBSSxVQUFVLENBQUM7UUFDZixpQkFBaUI7UUFDakIsSUFBSSxhQUFhLENBQUM7UUFDbEIsSUFBSSxTQUFTLENBQUM7UUFDZCxJQUFJLFFBQVEsQ0FBQztRQUNiLElBQUksYUFBYSxDQUFDO1FBQ2xCLElBQUksSUFBc0IsQ0FBQztRQUMzQixJQUFJLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUM3QixXQUFXLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQztZQUMzRixJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUMzQixXQUFXLEdBQUcsU0FBUyxDQUFDO2FBQzNCO1lBQ0QsSUFBSSxDQUFDLG9CQUFvQixHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxP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O0FBM0pELDJCQTJKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlcnZlciB9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IHsgYnVpbGRQcm92aWRlck1vZHVsZSB9IGZyb20gJ2ludmVyc2lmeS1iaW5kaW5nLWRlY29yYXRvcnMnO1xuaW1wb3J0IHsgSW52ZXJzaWZ5S29hU2VydmVyIH0gZnJvbSAnaW52ZXJzaWZ5LWtvYS11dGlscyc7XG5pbXBvcnQgeyBNaWRkbGV3YXJlIH0gZnJvbSAna29hJztcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSAna29hLWJvZHlwYXJzZXInO1xuaW1wb3J0ICogYXMgand0IGZyb20gJ2tvYS1qd3QnO1xuaW1wb3J0ICogYXMgbG9nNGpzIGZyb20gJ2tvYS1sb2c0JztcbmltcG9ydCAqIGFzIFJvdXRlciBmcm9tICdrb2Etcm91dGVyJztcbmltcG9ydCAqIGFzIGNvcnMgZnJvbSAna29hMi1jb3JzJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgKiBhcyBkZWZDb25maWcgZnJvbSAnLi9jb25maWcvZGVmY29uZmlnJztcbmltcG9ydCB7IGNvbnRhaW5lciB9IGZyb20gJy4vaW9jL2lvYyc7XG5pbXBvcnQgSW9jVHJhY2VyIGZyb20gJy4vaW9jL2lvY1RyYWNlcic7XG5pbXBvcnQga29hTG9nNGpzIGZyb20gJy4vbWlkZGxld2FyZXMvbG9nZ2VyL2xvZzRqcyc7XG5pbXBvcnQgR2FtYVJlc3BvbnNlIGZyb20gJy4vbW9kZWxzL0Jhc2VSZXNwb25zZSc7XG5pbXBvcnQgSHR0cEluaXRTZXR0aW5nIGZyb20gJy4vbW9kZWxzL0h0dHBJbml0U2V0dGluZyc7XG5pbXBvcnQgSVNlcnZlckluaXRPbmNlRXZlbnQgZnJvbSAnLi9TZXJ2ZXJFdmVudC9TZXJ2ZXJJbml0T25jZUV2ZW50JztcblxuY29uc3QgbG9nID0gbG9nNGpzLmdldExvZ2dlcignR1NlcnZlcicpO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV1NTZXJ2ZXIge1xuICAgIHByaXZhdGUgbWFpbjogUHJvbWlzZTxhbnk+O1xuICAgIHByaXZhdGUgc2VydmVySW5pdE9uY2VFdmVudHM6IElTZXJ2ZXJJbml0T25jZUV2ZW50W10gfCB1bmRlZmluZWQ7XG4gICAgcHJpdmF0ZSBrb2FTZXJ2ZXI6IFNlcnZlcjtcbiAgICBwcml2YXRlIHdzc1NlcnZlcjogV2ViU29ja2V0LlNlcnZlcjtcbiAgICBjb25zdHJ1Y3Rvcihpbml0U2V0dGluZzogSHR0cEluaXRTZXR0aW5nKSB7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlcztcbiAgICAgICAgbGV0IGRvbWFpbk5hbWU7XG4gICAgICAgIC8vIGxldCBtcVNldHRpbmc7XG4gICAgICAgIGxldCBqd3RQcml2YXRlS2V5O1xuICAgICAgICBsZXQgand0QWN0aXZlO1xuICAgICAgICBsZXQgaHR0cFBvcnQ7XG4gICAgICAgIGxldCBjb3JzV2hpdGVsaXN0O1xuICAgICAgICBsZXQgbG9nNDogKCkgPT4gTWlkZGxld2FyZTtcbiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nKSkge1xuICAgICAgICAgICAgbWlkZGxld2FyZXMgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLm1pZGRsZXdhcmVzKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLm1pZGRsZXdhcmVzO1xuICAgICAgICAgICAgaWYgKF8uc2l6ZShtaWRkbGV3YXJlcykgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlcyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmluaURhdGEpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcuaW5pRGF0YTtcbiAgICAgICAgICAgIGNvcnNXaGl0ZWxpc3QgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmNvcnNXaGl0ZWxpc3QpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcuY29yc1doaXRlbGlzdDtcbiAgICAgICAgICAgIGRvbWFpbk5hbWUgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmRvbWFpbk5hbWUpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcuZG9tYWluTmFtZTtcbiAgICAgICAgICAgIC8vIG1xU2V0dGluZyA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcubXFTZXR0aW5nKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLm1xU2V0dGluZztcbiAgICAgICAgICAgIGp3dFByaXZhdGVLZXkgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmp3dFByaXZhdGVLZXkpID9cbiAgICAgICAgICAgICAgICBkZWZDb25maWcuand0LnByaXZhdGVLZXkgOiBpbml0U2V0dGluZy5qd3RQcml2YXRlS2V5O1xuICAgICAgICAgICAgand0QWN0aXZlID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5qd3RBY3RpdmUpID8gZGVmQ29uZmlnLmp3dC5hY3RpdmUgOiBpbml0U2V0dGluZy5qd3RBY3RpdmU7XG4gICAgICAgICAgICBodHRwUG9ydCA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuaHR0cFBvcnQpID8gZGVmQ29uZmlnLmh0dHBQb3J0IDogaW5pdFNldHRpbmcuaHR0cFBvcnQ7XG4gICAgICAgICAgICBsb2c0ID0gXy5pc0Z1bmN0aW9uKGluaXRTZXR0aW5nLmxvZzQpID8ga29hTG9nNGpzIDogaW5pdFNldHRpbmcubG9nNCE7XG4gICAgICAgICAgICBjb250YWluZXIubG9hZChidWlsZFByb3ZpZGVyTW9kdWxlKCkpO1xuICAgICAgICAgICAgaWYgKGluaXRTZXR0aW5nLmZpbHRlcnNPcGVuKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW9jVHJhY2VyID0gbmV3IElvY1RyYWNlcihpbml0U2V0dGluZy5maWx0ZXJzKTtcbiAgICAgICAgICAgICAgICBpb2NUcmFjZXIuYXBwbHkoY29udGFpbmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyB0aGlzLm1haW4gPSBPUk1Db250ZXh0LmluaXQoaW5pdFNldHRpbmcucGF0aGRiLCBpbml0U2V0dGluZy5wYXRoQmVhbnNQYXRoKTtcbiAgICAgICAgLy8gY2FlYXRlIERCIGNvbm5lY3Rpb25cbiAgICAgICAgLy8g6YKE5LiN5pyD55So5YiwbXHmh4noqbLpgoTkuI3pnIDopoHljrvorpPku5bkuIDnm7TlmJfoqabpgKPnt5pcbiAgICAgICAgLy8gaWYgKCFfLmlzVW5kZWZpbmVkKG1xU2V0dGluZykpIHtcbiAgICAgICAgLy8gdGhpcy5tYWluLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbnVsbC1rZXl3b3JkXG4gICAgICAgIC8vIHJldHVybiBtcShudWxsLCBtcVNldHRpbmcpOyAvLyBjb25uZWN0IE1RIFNlcnZlclxuICAgICAgICAvLyB9KTtcbiAgICAgICAgLy8gfVxuICAgICAgICB0aGlzLm1haW4gPSBQcm9taXNlLnJlc29sdmUoMSk7XG4gICAgICAgIHRoaXMubWFpbi50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJvb3RSb3V0ZXIgPSBuZXcgUm91dGVyKHtcbiAgICAgICAgICAgICAgICBwcmVmaXg6IF8uaXNVbmRlZmluZWQoZG9tYWluTmFtZSkgPyAnJyA6IGRvbWFpbk5hbWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gY3JlYXRlIHNlcnZlclxuICAgICAgICAgICAgY29uc3Qgc2VydmVyID0gbmV3IEludmVyc2lmeUtvYVNlcnZlcihjb250YWluZXIsIHJvb3RSb3V0ZXIpO1xuICAgICAgICAgICAgc2VydmVyXG4gICAgICAgICAgICAgICAgLnNldENvbmZpZygoYXBwKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC51c2UoYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBjaGVjayB1c2VyIGF1dGggdG8gb3BlcmF0ZSBmdW5jdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBuZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IG5ldyBHYW1hUmVzcG9uc2UoZXJyLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c0FycmF5ID0gXy5tYXAoXy50b1N0cmluZyhlcnIuc3RhdHVzKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uc2l6ZShzdGF0dXNBcnJheSkgPT09IDQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQXJyYXlbMF0gaW4gWyc4JywgJzknLCAnNycsICc2JywgJzUnLCAnNCcsICczJywgJzInLCAnMScsICcwJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g6YCZ6YKKbWFw5piv5Zug54K66KaB5oqT5Y+W56ys5LiA5YCL5pW45a2X6ZaL6aCt562J5pa8OeWwseacg+i3kWVycm9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXNBcnJheVswXSA9PT0gJzknKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZXJyLnN0YXR1cywgZXJyLm1lc3NhZ2UsIEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZS51c2VyKSB8fCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cud2FybihlcnIuc3RhdHVzLCBlcnIubWVzc2FnZSwgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS4kc3RhdHVzID0gZXJyLnN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguc3RhdHVzID0gZXJyLnN0YXR1cyB8fCA1MDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlcnIuc3RhY2ssIEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZS51c2VyKSB8fCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLiRzdGF0dXMgPSBjdHguc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguYXBwLmVtaXQoJ2Vycm9yJywgZXJyLCBjdHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5ib2R5ID0gcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudXNlKGNvcnMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbjogKGN0eCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChjb3JzV2hpdGVsaXN0KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5zaXplKGNvcnNXaGl0ZWxpc3QpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyonO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF8uaW5jbHVkZXMoY29yc1doaXRlbGlzdCwgY3R4LmhlYWRlci5vcmlnaW4pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyonO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnN0YXR1cyA9IDQwNDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyg0MjIsIG5ldyBFcnJvcignTm90IEFsbG93IENvcnMnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC51c2UobG9nNCgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gLnVzZShtdWx0ZXIoe1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHN0b3JhZ2U6IG11bHRlci5tZW1vcnlTdG9yYWdlKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pLmFueSgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnVzZShib2R5UGFyc2VyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpY3Q6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uZXJyb3I6IChlcnIsIGN0eCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KDQyMiwgbmV3IEVycm9yKCdib2R5IHBhcnNlIGVycm9yJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKG1pZGRsZXdhcmVzKSAmJiBfLnNpemUobWlkZGxld2FyZXMpICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfLmZvckVhY2gobWlkZGxld2FyZXMsIChtaWRkbGV3YXJlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnVzZShtaWRkbGV3YXJlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFwcC51c2Uoand0KHsgc2VjcmV0OiBqd3RQcml2YXRlS2V5LCBwYXNzdGhyb3VnaDogIWp3dEFjdGl2ZSB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnVubGVzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aDogXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy51bmxlc3NQYXRoKSA/IFtdIDogaW5pdFNldHRpbmcudW5sZXNzUGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnNldEVycm9yQ29uZmlnKChhcHApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnVzZSgoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoY3R4LnN0YXR1cywgY3R4Lm1lc3NhZ2UsIEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZS51c2VyKSB8fCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5rb2FTZXJ2ZXIgPSBzZXJ2ZXIuYnVpbGQoKS5saXN0ZW4oaHR0cFBvcnQpO1xuICAgICAgICAgICAgdGhpcy53c3NTZXJ2ZXIgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgICAgICAgICAgICAgc2VydmVyOiB0aGlzLmtvYVNlcnZlclxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLndzc1NlcnZlci5vbignY29ubmVjdGlvbicsICh3czogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gd3MudXBncmFkZVJlceaYr+S4gOS4qnJlcXVlc3Tlr7nosaE6XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IHdzO1xuICAgICAgICAgICAgICAgIC8vIGlmICghdXNlcikge1xuICAgICAgICAgICAgICAgIC8vICAgICAvLyBDb29raWXkuI3lrZjlnKjmiJbml6DmlYjvvIznm7TmjqXlhbPpl61XZWJTb2NrZXQ6XG4gICAgICAgICAgICAgICAgLy8gICAgIHdzLmNsb3NlKDQwMDEsICdJbnZhbGlkIHVzZXInKTtcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgLy8g6K+G5Yir5oiQ5Yqf77yM5oqKdXNlcue7keWumuWIsOivpVdlYlNvY2tldOWvueixoTpcbiAgICAgICAgICAgICAgICB3cy51c2VyID0gdXNlcjtcbiAgICAgICAgICAgICAgICAvLyDnu5HlrppXZWJTb2NrZXRTZXJ2ZXLlr7nosaE6XG4gICAgICAgICAgICAgICAgd3Mud3NzID0gdGhpcy53c3NTZXJ2ZXI7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMud3NzU2VydmVyLm9uKCdvcGVuJywgZnVuY3Rpb24gb3BlbigpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY29ubmVjdGVkJyk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbG9nLmluZm8oJ0h0dHAgc3RhcnRlZCBsaXN0ZW5pbmcgb24gaHR0cDovL2xvY2FsaG9zdDolcyAuLi4nLCBodHRwUG9ydCk7XG4gICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG4gICAgcHVibGljIHN0YXJ0KCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMubWFpbikudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cykgJiYgXy5zaXplKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMpICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JFYWNoKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMsIChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZG9PbmNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZW5kKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy53c3NTZXJ2ZXI7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==