"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const clusterws_1 = require("clusterws");
const inversify_binding_decorators_1 = require("inversify-binding-decorators");
const inversify_koa_utils_1 = require("inversify-koa-utils");
const bodyParser = require("koa-bodyparser");
const jwt = require("koa-jwt");
const log4js = require("koa-log4");
const Router = require("koa-router");
const cors = require("koa2-cors");
const _ = require("lodash");
const defConfig = require("./config/defconfig");
const ioc_1 = require("./ioc/ioc");
const iocTracer_1 = require("./ioc/iocTracer");
const log4js_1 = require("./middlewares/logger/log4js");
const BaseResponse_1 = require("./models/BaseResponse");
const WebSocketContext_1 = require("./models/WebSocketContext");
const log = log4js.getLogger('GServer');
class WSServer {
    constructor(initSetting) {
        let middlewares;
        let domainName;
        // let mqSetting;
        let jwtPrivateKey;
        let jwtActive;
        let httpPort;
        let corsWhitelist;
        let log4;
        if (!_.isUndefined(initSetting)) {
            middlewares = _.isUndefined(initSetting.middlewares) ? undefined : initSetting.middlewares;
            if (_.size(middlewares) === 0) {
                middlewares = undefined;
            }
            this.serverInitOnceEvents = _.isUndefined(initSetting.iniData) ? undefined : initSetting.iniData;
            corsWhitelist = _.isUndefined(initSetting.corsWhitelist) ? undefined : initSetting.corsWhitelist;
            domainName = _.isUndefined(initSetting.domainName) ? undefined : initSetting.domainName;
            // mqSetting = _.isUndefined(initSetting.mqSetting) ? undefined : initSetting.mqSetting;
            jwtPrivateKey = _.isUndefined(initSetting.jwtPrivateKey) ?
                defConfig.jwt.privateKey : initSetting.jwtPrivateKey;
            jwtActive = _.isUndefined(initSetting.jwtActive) ? defConfig.jwt.active : initSetting.jwtActive;
            httpPort = _.isUndefined(initSetting.httpPort) ? defConfig.httpPort : initSetting.httpPort;
            log4 = _.isFunction(initSetting.log4) ? log4js_1.default : initSetting.log4;
            ioc_1.container.load(inversify_binding_decorators_1.buildProviderModule());
            if (initSetting.filtersOpen) {
                const iocTracer = new iocTracer_1.default(initSetting.filters);
                iocTracer.apply(ioc_1.container);
            }
        }
        // this.main = ORMContext.init(initSetting.pathdb, initSetting.pathBeansPath);
        this.main = Promise.resolve(1);
        this.main.then(() => {
            const rootRouter = new Router({
                prefix: _.isUndefined(domainName) ? '' : domainName
            });
            // create server
            const server = new inversify_koa_utils_1.InversifyKoaServer(ioc_1.container, rootRouter);
            server
                .setConfig((app) => {
                app.use(async (ctx, next) => {
                    // TODO check user auth to operate function
                    try {
                        await next();
                    }
                    catch (err) {
                        const response = new BaseResponse_1.default(err.message);
                        const statusArray = _.map(_.toString(err.status));
                        if (_.size(statusArray) === 4 &&
                            statusArray[0] in ['8', '9', '7', '6', '5', '4', '3', '2', '1', '0']) {
                            // 這邊map是因為要抓取第一個數字開頭等於9就會跑error
                            if (statusArray[0] === '9') {
                                log.error(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            else {
                                log.warn(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            response.$status = err.status;
                        }
                        else {
                            ctx.status = err.status || 500;
                            log.error(err.stack, JSON.stringify(ctx.state.user) || '');
                            response.$status = ctx.status;
                            ctx.app.emit('error', err, ctx);
                        }
                        ctx.body = response;
                    }
                })
                    .use(cors({
                    origin: (ctx) => {
                        if (_.isUndefined(corsWhitelist) ||
                            _.size(corsWhitelist) === 0) {
                            return '*';
                        }
                        else if (_.includes(corsWhitelist, ctx.header.origin)) {
                            return '*';
                        }
                        else {
                            ctx.status = 404;
                            ctx.throw(422, new Error('Not Allow Cors'));
                            return false;
                        }
                    }
                }))
                    .use(log4())
                    // .use(multer({
                    //     storage: multer.memoryStorage()
                    // }).any())
                    .use(bodyParser({
                    strict: false,
                    onerror: (err, ctx) => {
                        log.error(err);
                        ctx.throw(422, new Error('body parse error'));
                    }
                }));
                if (!_.isUndefined(middlewares) && _.size(middlewares) !== 0) {
                    _.forEach(middlewares, (middleware) => {
                        app.use(middleware);
                    });
                }
                app.use(jwt({ secret: jwtPrivateKey, passthrough: !jwtActive })
                    .unless({
                    path: _.isUndefined(initSetting.unlessPath) ? [] : initSetting.unlessPath
                }));
                this.wssServer = new clusterws_1.default({
                    worker: Worker(app, httpPort),
                    port: 3000
                });
            })
                .setErrorConfig((app) => {
                app.use((ctx, next) => {
                    log.error(ctx.status, ctx.message, JSON.stringify(ctx.state.user) || '');
                    next();
                });
            });
            // this.koaServer = server.build().listen(httpPort);
            // server.on('request', app.callback());
            // this.koaServer.on('upgrade', (request, socket, head) => {
            //     this.wssServer.handleUpgrade(request, socket, head, (ws) => {
            //         this.wssServer.emit('connection', ws, request);
            //     });
            // });
            // log.info('WebSocket started listening on ws://localhost:%s ...', httpPort);
        })
            .catch((e) => {
            log.error(e);
        });
    }
    start() {
        return Promise.resolve(this.main.then()).then(() => {
            if (!_.isUndefined(this.serverInitOnceEvents) && _.size(this.serverInitOnceEvents) !== 0) {
                _.forEach(this.serverInitOnceEvents, (element) => {
                    element.doOnce();
                    element.end();
                });
            }
        });
    }
}
exports.default = WSServer;
// const clusterws = new ClusterWS({
//     worker: Worker,
//     port: 3000
// });
function Worker(app, httpPort) {
    const wss = this.wss;
    const server = this.server;
    WebSocketContext_1.default.init(wss);
    server.on('request', app.callback());
    wss.on('connection', (socket) => {
        console.log('New socket is connected');
        log.info('WebSocket started listening on ws://localhost:%s ...', httpPort);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV1NTZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJXU1NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlDQUFrQztBQUVsQywrRUFBbUU7QUFDbkUsNkRBQXlEO0FBRXpELDZDQUE2QztBQUM3QywrQkFBK0I7QUFDL0IsbUNBQW1DO0FBQ25DLHFDQUFxQztBQUNyQyxrQ0FBa0M7QUFDbEMsNEJBQTRCO0FBQzVCLGdEQUFnRDtBQUNoRCxtQ0FBc0M7QUFDdEMsK0NBQXdDO0FBQ3hDLHdEQUFvRDtBQUNwRCx3REFBaUQ7QUFFakQsZ0VBQXlEO0FBR3pELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDeEMsTUFBcUIsUUFBUTtJQUt6QixZQUFZLFdBQTRCO1FBQ3BDLElBQUksV0FBVyxDQUFDO1FBQ2hCLElBQUksVUFBVSxDQUFDO1FBQ2YsaUJBQWlCO1FBQ2pCLElBQUksYUFBYSxDQUFDO1FBQ2xCLElBQUksU0FBUyxDQUFDO1FBQ2QsSUFBSSxRQUFRLENBQUM7UUFDYixJQUFJLGFBQWEsQ0FBQztRQUNsQixJQUFJLElBQXNCLENBQUM7UUFDM0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDN0IsV0FBVyxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUM7WUFDM0YsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDM0IsV0FBVyxHQUFHLFNBQVMsQ0FBQzthQUMzQjtZQUNELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FB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J2NsdXN0ZXJ3cyc7XG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tICdodHRwJztcbmltcG9ydCB7IGJ1aWxkUHJvdmlkZXJNb2R1bGUgfSBmcm9tICdpbnZlcnNpZnktYmluZGluZy1kZWNvcmF0b3JzJztcbmltcG9ydCB7IEludmVyc2lmeUtvYVNlcnZlciB9IGZyb20gJ2ludmVyc2lmeS1rb2EtdXRpbHMnO1xuaW1wb3J0IHsgTWlkZGxld2FyZSB9IGZyb20gJ2tvYSc7XG5pbXBvcnQgKiBhcyBib2R5UGFyc2VyIGZyb20gJ2tvYS1ib2R5cGFyc2VyJztcbmltcG9ydCAqIGFzIGp3dCBmcm9tICdrb2Etand0JztcbmltcG9ydCAqIGFzIGxvZzRqcyBmcm9tICdrb2EtbG9nNCc7XG5pbXBvcnQgKiBhcyBSb3V0ZXIgZnJvbSAna29hLXJvdXRlcic7XG5pbXBvcnQgKiBhcyBjb3JzIGZyb20gJ2tvYTItY29ycyc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBkZWZDb25maWcgZnJvbSAnLi9jb25maWcvZGVmY29uZmlnJztcbmltcG9ydCB7IGNvbnRhaW5lciB9IGZyb20gJy4vaW9jL2lvYyc7XG5pbXBvcnQgSW9jVHJhY2VyIGZyb20gJy4vaW9jL2lvY1RyYWNlcic7XG5pbXBvcnQga29hTG9nNGpzIGZyb20gJy4vbWlkZGxld2FyZXMvbG9nZ2VyL2xvZzRqcyc7XG5pbXBvcnQgR2FtYVJlc3BvbnNlIGZyb20gJy4vbW9kZWxzL0Jhc2VSZXNwb25zZSc7XG5pbXBvcnQgSHR0cEluaXRTZXR0aW5nIGZyb20gJy4vbW9kZWxzL0h0dHBJbml0U2V0dGluZyc7XG5pbXBvcnQgV2ViU29ja2V0Q29udGV4dCBmcm9tICcuL21vZGVscy9XZWJTb2NrZXRDb250ZXh0JztcbmltcG9ydCBJU2VydmVySW5pdE9uY2VFdmVudCBmcm9tICcuL1NlcnZlckV2ZW50L1NlcnZlckluaXRPbmNlRXZlbnQnO1xuXG5jb25zdCBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCdHU2VydmVyJyk7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXU1NlcnZlciB7XG4gICAgcHJpdmF0ZSBtYWluOiBQcm9taXNlPGFueT47XG4gICAgcHJpdmF0ZSBzZXJ2ZXJJbml0T25jZUV2ZW50czogSVNlcnZlckluaXRPbmNlRXZlbnRbXSB8IHVuZGVmaW5lZDtcbiAgICBwcml2YXRlIGtvYVNlcnZlcjogU2VydmVyO1xuICAgIHByaXZhdGUgd3NzU2VydmVyOiBDbHVzdGVyV1M7XG4gICAgY29uc3RydWN0b3IoaW5pdFNldHRpbmc6IEh0dHBJbml0U2V0dGluZykge1xuICAgICAgICBsZXQgbWlkZGxld2FyZXM7XG4gICAgICAgIGxldCBkb21haW5OYW1lO1xuICAgICAgICAvLyBsZXQgbXFTZXR0aW5nO1xuICAgICAgICBsZXQgand0UHJpdmF0ZUtleTtcbiAgICAgICAgbGV0IGp3dEFjdGl2ZTtcbiAgICAgICAgbGV0IGh0dHBQb3J0O1xuICAgICAgICBsZXQgY29yc1doaXRlbGlzdDtcbiAgICAgICAgbGV0IGxvZzQ6ICgpID0+IE1pZGRsZXdhcmU7XG4gICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZykpIHtcbiAgICAgICAgICAgIG1pZGRsZXdhcmVzID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5taWRkbGV3YXJlcykgPyB1bmRlZmluZWQgOiBpbml0U2V0dGluZy5taWRkbGV3YXJlcztcbiAgICAgICAgICAgIGlmIChfLnNpemUobWlkZGxld2FyZXMpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZXMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNlcnZlckluaXRPbmNlRXZlbnRzID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5pbmlEYXRhKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLmluaURhdGE7XG4gICAgICAgICAgICBjb3JzV2hpdGVsaXN0ID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5jb3JzV2hpdGVsaXN0KSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLmNvcnNXaGl0ZWxpc3Q7XG4gICAgICAgICAgICBkb21haW5OYW1lID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5kb21haW5OYW1lKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLmRvbWFpbk5hbWU7XG4gICAgICAgICAgICAvLyBtcVNldHRpbmcgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLm1xU2V0dGluZykgPyB1bmRlZmluZWQgOiBpbml0U2V0dGluZy5tcVNldHRpbmc7XG4gICAgICAgICAgICBqd3RQcml2YXRlS2V5ID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5qd3RQcml2YXRlS2V5KSA/XG4gICAgICAgICAgICAgICAgZGVmQ29uZmlnLmp3dC5wcml2YXRlS2V5IDogaW5pdFNldHRpbmcuand0UHJpdmF0ZUtleTtcbiAgICAgICAgICAgIGp3dEFjdGl2ZSA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuand0QWN0aXZlKSA/IGRlZkNvbmZpZy5qd3QuYWN0aXZlIDogaW5pdFNldHRpbmcuand0QWN0aXZlO1xuICAgICAgICAgICAgaHR0cFBvcnQgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmh0dHBQb3J0KSA/IGRlZkNvbmZpZy5odHRwUG9ydCA6IGluaXRTZXR0aW5nLmh0dHBQb3J0O1xuICAgICAgICAgICAgbG9nNCA9IF8uaXNGdW5jdGlvbihpbml0U2V0dGluZy5sb2c0KSA/IGtvYUxvZzRqcyA6IGluaXRTZXR0aW5nLmxvZzQhO1xuICAgICAgICAgICAgY29udGFpbmVyLmxvYWQoYnVpbGRQcm92aWRlck1vZHVsZSgpKTtcbiAgICAgICAgICAgIGlmIChpbml0U2V0dGluZy5maWx0ZXJzT3Blbikge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlvY1RyYWNlciA9IG5ldyBJb2NUcmFjZXIoaW5pdFNldHRpbmcuZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgaW9jVHJhY2VyLmFwcGx5KGNvbnRhaW5lcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gdGhpcy5tYWluID0gT1JNQ29udGV4dC5pbml0KGluaXRTZXR0aW5nLnBhdGhkYiwgaW5pdFNldHRpbmcucGF0aEJlYW5zUGF0aCk7XG4gICAgICAgIHRoaXMubWFpbiA9IFByb21pc2UucmVzb2x2ZSgxKTtcbiAgICAgICAgdGhpcy5tYWluLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgcm9vdFJvdXRlciA9IG5ldyBSb3V0ZXIoe1xuICAgICAgICAgICAgICAgIHByZWZpeDogXy5pc1VuZGVmaW5lZChkb21haW5OYW1lKSA/ICcnIDogZG9tYWluTmFtZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBjcmVhdGUgc2VydmVyXG4gICAgICAgICAgICBjb25zdCBzZXJ2ZXIgPSBuZXcgSW52ZXJzaWZ5S29hU2VydmVyKGNvbnRhaW5lciwgcm9vdFJvdXRlcik7XG4gICAgICAgICAgICBzZXJ2ZXJcbiAgICAgICAgICAgICAgICAuc2V0Q29uZmlnKChhcHApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnVzZShhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIGNoZWNrIHVzZXIgYXV0aCB0byBvcGVyYXRlIGZ1bmN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IEdhbWFSZXNwb25zZShlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzQXJyYXkgPSBfLm1hcChfLnRvU3RyaW5nKGVyci5zdGF0dXMpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5zaXplKHN0YXR1c0FycmF5KSA9PT0gNCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNBcnJheVswXSBpbiBbJzgnLCAnOScsICc3JywgJzYnLCAnNScsICc0JywgJzMnLCAnMicsICcxJywgJzAnXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyDpgJnpgoptYXDmmK/lm6DngrropoHmipPlj5bnrKzkuIDlgIvmlbjlrZfplovpoK3nrYnmlrw55bCx5pyD6LeRZXJyb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1c0FycmF5WzBdID09PSAnOScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlcnIuc3RhdHVzLCBlcnIubWVzc2FnZSwgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy53YXJuKGVyci5zdGF0dXMsIGVyci5tZXNzYWdlLCBKU09OLnN0cmluZ2lmeShjdHguc3RhdGUudXNlcikgfHwgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLiRzdGF0dXMgPSBlcnIuc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdGF0dXMgPSBlcnIuc3RhdHVzIHx8IDUwMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGVyci5zdGFjaywgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuJHN0YXR1cyA9IGN0eC5zdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hcHAuZW1pdCgnZXJyb3InLCBlcnIsIGN0eCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJvZHkgPSByZXNwb25zZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC51c2UoY29ycyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiAoY3R4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGNvcnNXaGl0ZWxpc3QpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLnNpemUoY29yc1doaXRlbGlzdCkgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnKic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXy5pbmNsdWRlcyhjb3JzV2hpdGVsaXN0LCBjdHguaGVhZGVyLm9yaWdpbikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnKic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguc3RhdHVzID0gNDA0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KDQyMiwgbmV3IEVycm9yKCdOb3QgQWxsb3cgQ29ycycpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnVzZShsb2c0KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAudXNlKG11bHRlcih7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgc3RvcmFnZTogbXVsdGVyLm1lbW9yeVN0b3JhZ2UoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gfSkuYW55KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAudXNlKGJvZHlQYXJzZXIoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmljdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25lcnJvcjogKGVyciwgY3R4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgudGhyb3coNDIyLCBuZXcgRXJyb3IoJ2JvZHkgcGFyc2UgZXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQobWlkZGxld2FyZXMpICYmIF8uc2l6ZShtaWRkbGV3YXJlcykgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChtaWRkbGV3YXJlcywgKG1pZGRsZXdhcmUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAudXNlKG1pZGRsZXdhcmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXBwLnVzZShqd3QoeyBzZWNyZXQ6IGp3dFByaXZhdGVLZXksIHBhc3N0aHJvdWdoOiAhand0QWN0aXZlIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudW5sZXNzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLnVubGVzc1BhdGgpID8gW10gOiBpbml0U2V0dGluZy51bmxlc3NQYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMud3NzU2VydmVyID0gbmV3IENsdXN0ZXJXUyh7XG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JrZXI6IFdvcmtlcihhcHAsIGh0dHBQb3J0KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcnQ6IDMwMDBcbiAgICAgICAgICAgICAgICAgICAgfSBhcyBhbnkpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnNldEVycm9yQ29uZmlnKChhcHApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnVzZSgoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoY3R4LnN0YXR1cywgY3R4Lm1lc3NhZ2UsIEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZS51c2VyKSB8fCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gdGhpcy5rb2FTZXJ2ZXIgPSBzZXJ2ZXIuYnVpbGQoKS5saXN0ZW4oaHR0cFBvcnQpO1xuICAgICAgICAgICAgLy8gc2VydmVyLm9uKCdyZXF1ZXN0JywgYXBwLmNhbGxiYWNrKCkpO1xuICAgICAgICAgICAgLy8gdGhpcy5rb2FTZXJ2ZXIub24oJ3VwZ3JhZGUnLCAocmVxdWVzdCwgc29ja2V0LCBoZWFkKSA9PiB7XG4gICAgICAgICAgICAvLyAgICAgdGhpcy53c3NTZXJ2ZXIuaGFuZGxlVXBncmFkZShyZXF1ZXN0LCBzb2NrZXQsIGhlYWQsICh3cykgPT4ge1xuICAgICAgICAgICAgLy8gICAgICAgICB0aGlzLndzc1NlcnZlci5lbWl0KCdjb25uZWN0aW9uJywgd3MsIHJlcXVlc3QpO1xuICAgICAgICAgICAgLy8gICAgIH0pO1xuICAgICAgICAgICAgLy8gfSk7XG4gICAgICAgICAgICAvLyBsb2cuaW5mbygnV2ViU29ja2V0IHN0YXJ0ZWQgbGlzdGVuaW5nIG9uIHdzOi8vbG9jYWxob3N0OiVzIC4uLicsIGh0dHBQb3J0KTtcbiAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICBwdWJsaWMgc3RhcnQoKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5tYWluLnRoZW4oKSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cykgJiYgXy5zaXplKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMpICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JFYWNoKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMsIChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZG9PbmNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZW5kKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbi8vIGNvbnN0IGNsdXN0ZXJ3cyA9IG5ldyBDbHVzdGVyV1Moe1xuLy8gICAgIHdvcmtlcjogV29ya2VyLFxuLy8gICAgIHBvcnQ6IDMwMDBcbi8vIH0pO1xuXG5mdW5jdGlvbiBXb3JrZXIoYXBwLCBodHRwUG9ydCkge1xuICAgIGNvbnN0IHdzcyA9IHRoaXMud3NzO1xuICAgIGNvbnN0IHNlcnZlciA9IHRoaXMuc2VydmVyO1xuICAgIFdlYlNvY2tldENvbnRleHQuaW5pdCh3c3MpO1xuICAgIHNlcnZlci5vbigncmVxdWVzdCcsIGFwcC5jYWxsYmFjaygpKTtcblxuICAgIHdzcy5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ05ldyBzb2NrZXQgaXMgY29ubmVjdGVkJyk7XG4gICAgICAgIGxvZy5pbmZvKCdXZWJTb2NrZXQgc3RhcnRlZCBsaXN0ZW5pbmcgb24gd3M6Ly9sb2NhbGhvc3Q6JXMgLi4uJywgaHR0cFBvcnQpO1xuICAgIH0pO1xufVxuIl19