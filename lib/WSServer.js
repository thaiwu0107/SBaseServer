"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Koa = require("koa");
const jwt = require("koa-jwt");
const log4js = require("koa-log4");
const WebSocketContext_1 = require("./models/WebSocketContext");
const log = log4js.getLogger('WSServer');
let privateKey;
let active;
let port;
function Init(_privateKey, _active, _port) {
    privateKey = _privateKey;
    active = _active;
    port = _port;
}
exports.Init = Init;
function Worker() {
    const wss = this.wss;
    const server = this.server;
    const app = new Koa();
    app.use(jwt({ secret: privateKey, passthrough: !active }));
    WebSocketContext_1.default.init(wss);
    server.on('request', app.callback());
    wss.on('connection', (socket) => {
        console.log('New socket is connected');
    });
    log.info('WebSocket started listening on ws://localhost:%s ...', port);
}
exports.Worker = Worker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV1NTZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJXU1NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJCQUEyQjtBQUMzQiwrQkFBK0I7QUFDL0IsbUNBQW1DO0FBQ25DLGdFQUF5RDtBQUV6RCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3pDLElBQUksVUFBVSxDQUFDO0FBQ2YsSUFBSSxNQUFNLENBQUM7QUFDWCxJQUFJLElBQUksQ0FBQztBQUNULFNBQWdCLElBQUksQ0FBQyxXQUFXLEVBQUUsT0FBTyxFQUFFLEtBQUs7SUFDNUMsVUFBVSxHQUFHLFdBQVcsQ0FBQztJQUN6QixNQUFNLEdBQUcsT0FBTyxDQUFDO0lBQ2pCLElBQUksR0FBRyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUpELG9CQUlDO0FBQ0QsU0FBZ0IsTUFBTTtJQUNsQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQ3JCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDM0IsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUN0QixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzNELDBCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQixNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUNyQyxHQUFHLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztJQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsc0RBQXNELEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDM0UsQ0FBQztBQVhELHdCQVdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgS29hIGZyb20gJ2tvYSc7XG5pbXBvcnQgKiBhcyBqd3QgZnJvbSAna29hLWp3dCc7XG5pbXBvcnQgKiBhcyBsb2c0anMgZnJvbSAna29hLWxvZzQnO1xuaW1wb3J0IFdlYlNvY2tldENvbnRleHQgZnJvbSAnLi9tb2RlbHMvV2ViU29ja2V0Q29udGV4dCc7XG5cbmNvbnN0IGxvZyA9IGxvZzRqcy5nZXRMb2dnZXIoJ1dTU2VydmVyJyk7XG5sZXQgcHJpdmF0ZUtleTtcbmxldCBhY3RpdmU7XG5sZXQgcG9ydDtcbmV4cG9ydCBmdW5jdGlvbiBJbml0KF9wcml2YXRlS2V5LCBfYWN0aXZlLCBfcG9ydCkge1xuICAgIHByaXZhdGVLZXkgPSBfcHJpdmF0ZUtleTtcbiAgICBhY3RpdmUgPSBfYWN0aXZlO1xuICAgIHBvcnQgPSBfcG9ydDtcbn1cbmV4cG9ydCBmdW5jdGlvbiBXb3JrZXIoKSB7XG4gICAgY29uc3Qgd3NzID0gdGhpcy53c3M7XG4gICAgY29uc3Qgc2VydmVyID0gdGhpcy5zZXJ2ZXI7XG4gICAgY29uc3QgYXBwID0gbmV3IEtvYSgpO1xuICAgIGFwcC51c2Uoand0KHsgc2VjcmV0OiBwcml2YXRlS2V5LCBwYXNzdGhyb3VnaDogIWFjdGl2ZSB9KSk7XG4gICAgV2ViU29ja2V0Q29udGV4dC5pbml0KHdzcyk7XG4gICAgc2VydmVyLm9uKCdyZXF1ZXN0JywgYXBwLmNhbGxiYWNrKCkpO1xuICAgIHdzcy5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ05ldyBzb2NrZXQgaXMgY29ubmVjdGVkJyk7XG4gICAgfSk7XG4gICAgbG9nLmluZm8oJ1dlYlNvY2tldCBzdGFydGVkIGxpc3RlbmluZyBvbiB3czovL2xvY2FsaG9zdDolcyAuLi4nLCBwb3J0KTtcbn1cbiJdfQ==