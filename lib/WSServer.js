"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const inversify_binding_decorators_1 = require("inversify-binding-decorators");
const inversify_koa_utils_1 = require("inversify-koa-utils");
const bodyParser = require("koa-bodyparser");
const jwt = require("koa-jwt");
const log4js = require("koa-log4");
const Router = require("koa-router");
const cors = require("koa2-cors");
const _ = require("lodash");
const WebSocket = require("ws");
const defConfig = require("./config/defconfig");
const ioc_1 = require("./ioc/ioc");
const iocTracer_1 = require("./ioc/iocTracer");
const log4js_1 = require("./middlewares/logger/log4js");
const BaseResponse_1 = require("./models/BaseResponse");
const WebSocketContext_1 = require("./models/WebSocketContext");
const log = log4js.getLogger('GServer');
class WSServer {
    constructor(initSetting) {
        let middlewares;
        let domainName;
        // let mqSetting;
        let jwtPrivateKey;
        let jwtActive;
        let httpPort;
        let corsWhitelist;
        let log4;
        if (!_.isUndefined(initSetting)) {
            middlewares = _.isUndefined(initSetting.middlewares) ? undefined : initSetting.middlewares;
            if (_.size(middlewares) === 0) {
                middlewares = undefined;
            }
            this.serverInitOnceEvents = _.isUndefined(initSetting.iniData) ? undefined : initSetting.iniData;
            corsWhitelist = _.isUndefined(initSetting.corsWhitelist) ? undefined : initSetting.corsWhitelist;
            domainName = _.isUndefined(initSetting.domainName) ? undefined : initSetting.domainName;
            // mqSetting = _.isUndefined(initSetting.mqSetting) ? undefined : initSetting.mqSetting;
            jwtPrivateKey = _.isUndefined(initSetting.jwtPrivateKey) ?
                defConfig.jwt.privateKey : initSetting.jwtPrivateKey;
            jwtActive = _.isUndefined(initSetting.jwtActive) ? defConfig.jwt.active : initSetting.jwtActive;
            httpPort = _.isUndefined(initSetting.httpPort) ? defConfig.httpPort : initSetting.httpPort;
            log4 = _.isFunction(initSetting.log4) ? log4js_1.default : initSetting.log4;
            ioc_1.container.load(inversify_binding_decorators_1.buildProviderModule());
            if (initSetting.filtersOpen) {
                const iocTracer = new iocTracer_1.default(initSetting.filters);
                iocTracer.apply(ioc_1.container);
            }
        }
        // this.main = ORMContext.init(initSetting.pathdb, initSetting.pathBeansPath);
        this.main = Promise.resolve(1);
        this.main.then(() => {
            const rootRouter = new Router({
                prefix: _.isUndefined(domainName) ? '' : domainName
            });
            // create server
            const server = new inversify_koa_utils_1.InversifyKoaServer(ioc_1.container, rootRouter);
            server
                .setConfig((app) => {
                app.use(async (ctx, next) => {
                    // TODO check user auth to operate function
                    try {
                        await next();
                    }
                    catch (err) {
                        const response = new BaseResponse_1.default(err.message);
                        const statusArray = _.map(_.toString(err.status));
                        if (_.size(statusArray) === 4 &&
                            statusArray[0] in ['8', '9', '7', '6', '5', '4', '3', '2', '1', '0']) {
                            // 這邊map是因為要抓取第一個數字開頭等於9就會跑error
                            if (statusArray[0] === '9') {
                                log.error(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            else {
                                log.warn(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            response.$status = err.status;
                        }
                        else {
                            ctx.status = err.status || 500;
                            log.error(err.stack, JSON.stringify(ctx.state.user) || '');
                            response.$status = ctx.status;
                            ctx.app.emit('error', err, ctx);
                        }
                        ctx.body = response;
                    }
                })
                    .use(cors({
                    origin: (ctx) => {
                        if (_.isUndefined(corsWhitelist) ||
                            _.size(corsWhitelist) === 0) {
                            return '*';
                        }
                        else if (_.includes(corsWhitelist, ctx.header.origin)) {
                            return '*';
                        }
                        else {
                            ctx.status = 404;
                            ctx.throw(422, new Error('Not Allow Cors'));
                            return false;
                        }
                    }
                }))
                    .use(log4())
                    // .use(multer({
                    //     storage: multer.memoryStorage()
                    // }).any())
                    .use(bodyParser({
                    strict: false,
                    onerror: (err, ctx) => {
                        log.error(err);
                        ctx.throw(422, new Error('body parse error'));
                    }
                }));
                if (!_.isUndefined(middlewares) && _.size(middlewares) !== 0) {
                    _.forEach(middlewares, (middleware) => {
                        app.use(middleware);
                    });
                }
                app.use(jwt({ secret: jwtPrivateKey, passthrough: !jwtActive })
                    .unless({
                    path: _.isUndefined(initSetting.unlessPath) ? [] : initSetting.unlessPath
                }));
            })
                .setErrorConfig((app) => {
                app.use((ctx, next) => {
                    log.error(ctx.status, ctx.message, JSON.stringify(ctx.state.user) || '');
                    next();
                });
            });
            this.koaServer = server.build().listen(httpPort);
            this.wssServer = new WebSocket.Server({
                noServer: true
            });
            WebSocketContext_1.default.init(this.wssServer);
            this.koaServer.on('upgrade', (request, socket, head) => {
                this.wssServer.handleUpgrade(request, socket, head, (ws) => {
                    this.wssServer.emit('connection', ws, request);
                });
            });
            log.info('WebSocket started listening on ws://localhost:%s ...', httpPort);
        })
            .catch((e) => {
            log.error(e);
        });
    }
    start() {
        return Promise.resolve(this.main).then(() => {
            if (!_.isUndefined(this.serverInitOnceEvents) && _.size(this.serverInitOnceEvents) !== 0) {
                _.forEach(this.serverInitOnceEvents, (element) => {
                    element.doOnce();
                    element.end();
                });
            }
        });
    }
}
exports.default = WSServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV1NTZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJXU1NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtFQUFtRTtBQUNuRSw2REFBeUQ7QUFFekQsNkNBQTZDO0FBQzdDLCtCQUErQjtBQUMvQixtQ0FBbUM7QUFDbkMscUNBQXFDO0FBQ3JDLGtDQUFrQztBQUNsQyw0QkFBNEI7QUFDNUIsZ0NBQWdDO0FBQ2hDLGdEQUFnRDtBQUNoRCxtQ0FBc0M7QUFDdEMsK0NBQXdDO0FBQ3hDLHdEQUFvRDtBQUNwRCx3REFBaUQ7QUFFakQsZ0VBQXlEO0FBR3pELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDeEMsTUFBcUIsUUFBUTtJQUt6QixZQUFZLFdBQTRCO1FBQ3BDLElBQUksV0FBVyxDQUFDO1FBQ2hCLElBQUksVUFBVSxDQUFDO1FBQ2YsaUJBQWlCO1FBQ2pCLElBQUksYUFBYSxDQUFDO1FBQ2xCLElBQUksU0FBUyxDQUFDO1FBQ2QsSUFBSSxRQUFRLENBQUM7UUFDYixJQUFJLGFBQWEsQ0FBQztRQUNsQixJQUFJLElBQXNCLENBQUM7UUFDM0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDN0IsV0FBVyxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUM7WUFDM0YsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDM0IsV0FBVyxHQUFHLFNBQVMsQ0FBQzthQUMzQjtZQUNELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FB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RUFBRSxFQUFFLEVBQUU7b0JBQ3ZELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ2pELENBQUMsQ0FBQyxDQUFDO1lBQ1QsQ0FBQyxDQUFDLENBQUM7WUFDSCxHQUFHLENBQUMsSUFBSSxDQUFDLHNEQUFzRCxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9FLENBQUMsQ0FBQzthQUNHLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ1QsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztJQUNYLENBQUM7SUFDTSxLQUFLO1FBQ1IsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUN0RixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO29CQUM3QyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDbEIsQ0FBQyxDQUFDLENBQUM7YUFDTjtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBeklELDJCQXlJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlcnZlciB9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IHsgYnVpbGRQcm92aWRlck1vZHVsZSB9IGZyb20gJ2ludmVyc2lmeS1iaW5kaW5nLWRlY29yYXRvcnMnO1xuaW1wb3J0IHsgSW52ZXJzaWZ5S29hU2VydmVyIH0gZnJvbSAnaW52ZXJzaWZ5LWtvYS11dGlscyc7XG5pbXBvcnQgeyBNaWRkbGV3YXJlIH0gZnJvbSAna29hJztcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSAna29hLWJvZHlwYXJzZXInO1xuaW1wb3J0ICogYXMgand0IGZyb20gJ2tvYS1qd3QnO1xuaW1wb3J0ICogYXMgbG9nNGpzIGZyb20gJ2tvYS1sb2c0JztcbmltcG9ydCAqIGFzIFJvdXRlciBmcm9tICdrb2Etcm91dGVyJztcbmltcG9ydCAqIGFzIGNvcnMgZnJvbSAna29hMi1jb3JzJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgKiBhcyBkZWZDb25maWcgZnJvbSAnLi9jb25maWcvZGVmY29uZmlnJztcbmltcG9ydCB7IGNvbnRhaW5lciB9IGZyb20gJy4vaW9jL2lvYyc7XG5pbXBvcnQgSW9jVHJhY2VyIGZyb20gJy4vaW9jL2lvY1RyYWNlcic7XG5pbXBvcnQga29hTG9nNGpzIGZyb20gJy4vbWlkZGxld2FyZXMvbG9nZ2VyL2xvZzRqcyc7XG5pbXBvcnQgR2FtYVJlc3BvbnNlIGZyb20gJy4vbW9kZWxzL0Jhc2VSZXNwb25zZSc7XG5pbXBvcnQgSHR0cEluaXRTZXR0aW5nIGZyb20gJy4vbW9kZWxzL0h0dHBJbml0U2V0dGluZyc7XG5pbXBvcnQgV2ViU29ja2V0Q29udGV4dCBmcm9tICcuL21vZGVscy9XZWJTb2NrZXRDb250ZXh0JztcbmltcG9ydCBJU2VydmVySW5pdE9uY2VFdmVudCBmcm9tICcuL1NlcnZlckV2ZW50L1NlcnZlckluaXRPbmNlRXZlbnQnO1xuXG5jb25zdCBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCdHU2VydmVyJyk7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXU1NlcnZlciB7XG4gICAgcHJpdmF0ZSBtYWluOiBQcm9taXNlPGFueT47XG4gICAgcHJpdmF0ZSBzZXJ2ZXJJbml0T25jZUV2ZW50czogSVNlcnZlckluaXRPbmNlRXZlbnRbXSB8IHVuZGVmaW5lZDtcbiAgICBwcml2YXRlIGtvYVNlcnZlcjogU2VydmVyO1xuICAgIHByaXZhdGUgd3NzU2VydmVyOiBXZWJTb2NrZXQuU2VydmVyO1xuICAgIGNvbnN0cnVjdG9yKGluaXRTZXR0aW5nOiBIdHRwSW5pdFNldHRpbmcpIHtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVzO1xuICAgICAgICBsZXQgZG9tYWluTmFtZTtcbiAgICAgICAgLy8gbGV0IG1xU2V0dGluZztcbiAgICAgICAgbGV0IGp3dFByaXZhdGVLZXk7XG4gICAgICAgIGxldCBqd3RBY3RpdmU7XG4gICAgICAgIGxldCBodHRwUG9ydDtcbiAgICAgICAgbGV0IGNvcnNXaGl0ZWxpc3Q7XG4gICAgICAgIGxldCBsb2c0OiAoKSA9PiBNaWRkbGV3YXJlO1xuICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcpKSB7XG4gICAgICAgICAgICBtaWRkbGV3YXJlcyA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcubWlkZGxld2FyZXMpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcubWlkZGxld2FyZXM7XG4gICAgICAgICAgICBpZiAoXy5zaXplKG1pZGRsZXdhcmVzKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cyA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuaW5pRGF0YSkgPyB1bmRlZmluZWQgOiBpbml0U2V0dGluZy5pbmlEYXRhO1xuICAgICAgICAgICAgY29yc1doaXRlbGlzdCA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuY29yc1doaXRlbGlzdCkgPyB1bmRlZmluZWQgOiBpbml0U2V0dGluZy5jb3JzV2hpdGVsaXN0O1xuICAgICAgICAgICAgZG9tYWluTmFtZSA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuZG9tYWluTmFtZSkgPyB1bmRlZmluZWQgOiBpbml0U2V0dGluZy5kb21haW5OYW1lO1xuICAgICAgICAgICAgLy8gbXFTZXR0aW5nID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5tcVNldHRpbmcpID8gdW5kZWZpbmVkIDogaW5pdFNldHRpbmcubXFTZXR0aW5nO1xuICAgICAgICAgICAgand0UHJpdmF0ZUtleSA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuand0UHJpdmF0ZUtleSkgP1xuICAgICAgICAgICAgICAgIGRlZkNvbmZpZy5qd3QucHJpdmF0ZUtleSA6IGluaXRTZXR0aW5nLmp3dFByaXZhdGVLZXk7XG4gICAgICAgICAgICBqd3RBY3RpdmUgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmp3dEFjdGl2ZSkgPyBkZWZDb25maWcuand0LmFjdGl2ZSA6IGluaXRTZXR0aW5nLmp3dEFjdGl2ZTtcbiAgICAgICAgICAgIGh0dHBQb3J0ID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5odHRwUG9ydCkgPyBkZWZDb25maWcuaHR0cFBvcnQgOiBpbml0U2V0dGluZy5odHRwUG9ydDtcbiAgICAgICAgICAgIGxvZzQgPSBfLmlzRnVuY3Rpb24oaW5pdFNldHRpbmcubG9nNCkgPyBrb2FMb2c0anMgOiBpbml0U2V0dGluZy5sb2c0ITtcbiAgICAgICAgICAgIGNvbnRhaW5lci5sb2FkKGJ1aWxkUHJvdmlkZXJNb2R1bGUoKSk7XG4gICAgICAgICAgICBpZiAoaW5pdFNldHRpbmcuZmlsdGVyc09wZW4pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpb2NUcmFjZXIgPSBuZXcgSW9jVHJhY2VyKGluaXRTZXR0aW5nLmZpbHRlcnMpO1xuICAgICAgICAgICAgICAgIGlvY1RyYWNlci5hcHBseShjb250YWluZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIHRoaXMubWFpbiA9IE9STUNvbnRleHQuaW5pdChpbml0U2V0dGluZy5wYXRoZGIsIGluaXRTZXR0aW5nLnBhdGhCZWFuc1BhdGgpO1xuICAgICAgICB0aGlzLm1haW4gPSBQcm9taXNlLnJlc29sdmUoMSk7XG4gICAgICAgIHRoaXMubWFpbi50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJvb3RSb3V0ZXIgPSBuZXcgUm91dGVyKHtcbiAgICAgICAgICAgICAgICBwcmVmaXg6IF8uaXNVbmRlZmluZWQoZG9tYWluTmFtZSkgPyAnJyA6IGRvbWFpbk5hbWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gY3JlYXRlIHNlcnZlclxuICAgICAgICAgICAgY29uc3Qgc2VydmVyID0gbmV3IEludmVyc2lmeUtvYVNlcnZlcihjb250YWluZXIsIHJvb3RSb3V0ZXIpO1xuICAgICAgICAgICAgc2VydmVyXG4gICAgICAgICAgICAgICAgLnNldENvbmZpZygoYXBwKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC51c2UoYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBjaGVjayB1c2VyIGF1dGggdG8gb3BlcmF0ZSBmdW5jdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBuZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IG5ldyBHYW1hUmVzcG9uc2UoZXJyLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c0FycmF5ID0gXy5tYXAoXy50b1N0cmluZyhlcnIuc3RhdHVzKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uc2l6ZShzdGF0dXNBcnJheSkgPT09IDQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQXJyYXlbMF0gaW4gWyc4JywgJzknLCAnNycsICc2JywgJzUnLCAnNCcsICczJywgJzInLCAnMScsICcwJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g6YCZ6YKKbWFw5piv5Zug54K66KaB5oqT5Y+W56ys5LiA5YCL5pW45a2X6ZaL6aCt562J5pa8OeWwseacg+i3kWVycm9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXNBcnJheVswXSA9PT0gJzknKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZXJyLnN0YXR1cywgZXJyLm1lc3NhZ2UsIEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZS51c2VyKSB8fCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cud2FybihlcnIuc3RhdHVzLCBlcnIubWVzc2FnZSwgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS4kc3RhdHVzID0gZXJyLnN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguc3RhdHVzID0gZXJyLnN0YXR1cyB8fCA1MDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlcnIuc3RhY2ssIEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZS51c2VyKSB8fCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLiRzdGF0dXMgPSBjdHguc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguYXBwLmVtaXQoJ2Vycm9yJywgZXJyLCBjdHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5ib2R5ID0gcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudXNlKGNvcnMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbjogKGN0eCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChjb3JzV2hpdGVsaXN0KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5zaXplKGNvcnNXaGl0ZWxpc3QpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyonO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF8uaW5jbHVkZXMoY29yc1doaXRlbGlzdCwgY3R4LmhlYWRlci5vcmlnaW4pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyonO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnN0YXR1cyA9IDQwNDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyg0MjIsIG5ldyBFcnJvcignTm90IEFsbG93IENvcnMnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC51c2UobG9nNCgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gLnVzZShtdWx0ZXIoe1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHN0b3JhZ2U6IG11bHRlci5tZW1vcnlTdG9yYWdlKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pLmFueSgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnVzZShib2R5UGFyc2VyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpY3Q6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uZXJyb3I6IChlcnIsIGN0eCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KDQyMiwgbmV3IEVycm9yKCdib2R5IHBhcnNlIGVycm9yJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKG1pZGRsZXdhcmVzKSAmJiBfLnNpemUobWlkZGxld2FyZXMpICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfLmZvckVhY2gobWlkZGxld2FyZXMsIChtaWRkbGV3YXJlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnVzZShtaWRkbGV3YXJlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFwcC51c2Uoand0KHsgc2VjcmV0OiBqd3RQcml2YXRlS2V5LCBwYXNzdGhyb3VnaDogIWp3dEFjdGl2ZSB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnVubGVzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aDogXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy51bmxlc3NQYXRoKSA/IFtdIDogaW5pdFNldHRpbmcudW5sZXNzUGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnNldEVycm9yQ29uZmlnKChhcHApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnVzZSgoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoY3R4LnN0YXR1cywgY3R4Lm1lc3NhZ2UsIEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZS51c2VyKSB8fCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5rb2FTZXJ2ZXIgPSBzZXJ2ZXIuYnVpbGQoKS5saXN0ZW4oaHR0cFBvcnQpO1xuICAgICAgICAgICAgdGhpcy53c3NTZXJ2ZXIgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgICAgICAgICAgICAgbm9TZXJ2ZXI6IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgV2ViU29ja2V0Q29udGV4dC5pbml0KHRoaXMud3NzU2VydmVyKTtcbiAgICAgICAgICAgIHRoaXMua29hU2VydmVyLm9uKCd1cGdyYWRlJywgKHJlcXVlc3QsIHNvY2tldCwgaGVhZCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMud3NzU2VydmVyLmhhbmRsZVVwZ3JhZGUocmVxdWVzdCwgc29ja2V0LCBoZWFkLCAod3MpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53c3NTZXJ2ZXIuZW1pdCgnY29ubmVjdGlvbicsIHdzLCByZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsb2cuaW5mbygnV2ViU29ja2V0IHN0YXJ0ZWQgbGlzdGVuaW5nIG9uIHdzOi8vbG9jYWxob3N0OiVzIC4uLicsIGh0dHBQb3J0KTtcbiAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICBwdWJsaWMgc3RhcnQoKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5tYWluKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCh0aGlzLnNlcnZlckluaXRPbmNlRXZlbnRzKSAmJiBfLnNpemUodGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cykgIT09IDApIHtcbiAgICAgICAgICAgICAgICBfLmZvckVhY2godGhpcy5zZXJ2ZXJJbml0T25jZUV2ZW50cywgKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5kb09uY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5lbmQoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19