"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const inversify_binding_decorators_1 = require("inversify-binding-decorators");
const inversify_koa_utils_1 = require("inversify-koa-utils");
const bodyParser = require("koa-bodyparser");
const jwt = require("koa-jwt");
const log4js = require("koa-log4");
// import * as multer from 'koa-multer';
const Router = require("koa-router");
const cors = require("koa2-cors");
const _ = require("lodash");
const defConfig = require("./config/defconfig");
const ioc_1 = require("./ioc/ioc");
const iocTracer_1 = require("./ioc/iocTracer");
const log4js_1 = require("./middlewares/logger/log4js");
const models_1 = require("./models");
const BaseResponse_1 = require("./models/BaseResponse");
const log = log4js.getLogger('GServer');
class GServer {
    constructor(initSetting) {
        let middlewares;
        let domainName;
        // let mqSetting;
        let jwtPrivateKey;
        let jwtActive;
        let httpPort;
        let corsWhitelist;
        let log4;
        if (!_.isUndefined(initSetting)) {
            middlewares = _.isUndefined(initSetting.middlewares) ? undefined : initSetting.middlewares;
            if (_.size(middlewares) === 0) {
                middlewares = undefined;
            }
            this.serverInitOnceEvents = _.isUndefined(initSetting.iniData) ? undefined : initSetting.iniData;
            corsWhitelist = _.isUndefined(initSetting.corsWhitelist) ? undefined : initSetting.corsWhitelist;
            domainName = _.isUndefined(initSetting.domainName) ? undefined : initSetting.domainName;
            // mqSetting = _.isUndefined(initSetting.mqSetting) ? undefined : initSetting.mqSetting;
            jwtPrivateKey = _.isUndefined(initSetting.jwtPrivateKey) ?
                defConfig.jwt.privateKey : initSetting.jwtPrivateKey;
            jwtActive = _.isUndefined(initSetting.jwtActive) ? defConfig.jwt.active : initSetting.jwtActive;
            httpPort = _.isUndefined(initSetting.httpPort) ? defConfig.httpPort : initSetting.httpPort;
            log4 = _.isFunction(initSetting.log4) ? log4js_1.default : initSetting.log4;
            ioc_1.container.load(inversify_binding_decorators_1.buildProviderModule());
            if (initSetting.filtersOpen) {
                const iocTracer = new iocTracer_1.default(initSetting.filters);
                iocTracer.apply(ioc_1.container);
            }
        }
        this.main = models_1.ORMContext.init(initSetting.pathdb, initSetting.pathBeansPath);
        // caeate DB connection
        // 還不會用到mq應該還不需要去讓他一直嘗試連線
        // if (!_.isUndefined(mqSetting)) {
        // this.main.then((result) => {
        // tslint:disable-next-line:no-null-keyword
        // return mq(null, mqSetting); // connect MQ Server
        // });
        // }
        this.main.then(() => {
            const rootRouter = new Router({
                prefix: _.isUndefined(domainName) ? '' : domainName
            });
            // create server
            const server = new inversify_koa_utils_1.InversifyKoaServer(ioc_1.container, rootRouter);
            server
                .setConfig((app) => {
                app.use(async (ctx, next) => {
                    // TODO check user auth to operate function
                    try {
                        await next();
                    }
                    catch (err) {
                        const response = new BaseResponse_1.default(err.message);
                        const statusArray = _.map(_.toString(err.status));
                        if (_.size(statusArray) === 4 &&
                            statusArray[0] in ['8', '9', '7', '6', '5', '4', '3', '2', '1', '0']) {
                            // 這邊map是因為要抓取第一個數字開頭等於9就會跑error
                            if (statusArray[0] === '9') {
                                log.error(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            else {
                                log.warn(err.status, err.message, JSON.stringify(ctx.state.user) || '');
                            }
                            response.$status = err.status;
                        }
                        else {
                            ctx.status = err.status || 500;
                            log.error(err.stack, JSON.stringify(ctx.state.user) || '');
                            response.$status = ctx.status;
                            ctx.app.emit('error', err, ctx);
                        }
                        ctx.body = response;
                    }
                })
                    .use(cors({
                    origin: (ctx) => {
                        if (_.isUndefined(corsWhitelist) ||
                            _.size(corsWhitelist) === 0) {
                            return '*';
                        }
                        else if (_.includes(corsWhitelist, ctx.header.origin)) {
                            return '*';
                        }
                        else {
                            ctx.status = 404;
                            ctx.throw(422, new Error('Not Allow Cors'));
                            return false;
                        }
                    }
                }))
                    .use(log4())
                    // .use(multer({
                    //     storage: multer.memoryStorage()
                    // }).any())
                    .use(bodyParser({
                    strict: false,
                    onerror: (err, ctx) => {
                        log.error(err);
                        ctx.throw(422, new Error('body parse error'));
                    }
                }));
                if (!_.isUndefined(middlewares) && _.size(middlewares) !== 0) {
                    _.forEach(middlewares, (middleware) => {
                        app.use(middleware);
                    });
                }
                app.use(jwt({ secret: jwtPrivateKey, passthrough: !jwtActive })
                    .unless({
                    path: _.isUndefined(initSetting.unlessPath) ? [] : initSetting.unlessPath
                }));
            })
                .setErrorConfig((app) => {
                app.use((ctx, next) => {
                    log.error(ctx.status, ctx.message, JSON.stringify(ctx.state.user) || '');
                    next();
                });
            });
            this.koaServer = server.build().listen(httpPort);
            log.info('Http started listening on http://localhost:%s ...', httpPort);
        })
            .catch((e) => {
            log.error(e);
        });
    }
    async start() {
        await Promise.all([this.main]);
        if (!_.isUndefined(this.serverInitOnceEvents) && _.size(this.serverInitOnceEvents) !== 0) {
            _.forEach(this.serverInitOnceEvents, (element) => {
                element.doOnce();
                element.end();
            });
        }
        return this.koaServer;
    }
}
exports.default = GServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR1NlcnZlci5qcyIsInNvdXJjZVJvb3QiOiIuL3NyYy8iLCJzb3VyY2VzIjpbIkdTZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSwrRUFBbUU7QUFDbkUsNkRBQXlEO0FBRXpELDZDQUE2QztBQUM3QywrQkFBK0I7QUFDL0IsbUNBQW1DO0FBQ25DLHdDQUF3QztBQUN4QyxxQ0FBcUM7QUFDckMsa0NBQWtDO0FBQ2xDLDRCQUE0QjtBQUM1QixnREFBZ0Q7QUFDaEQsbUNBQXNDO0FBQ3RDLCtDQUF3QztBQUN4Qyx3REFBb0Q7QUFDcEQscUNBQXNDO0FBQ3RDLHdEQUFpRDtBQUlqRCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3hDLE1BQXFCLE9BQU87SUFJeEIsWUFBWSxXQUE0QjtRQUNwQyxJQUFJLFdBQVcsQ0FBQztRQUNoQixJQUFJLFVBQVUsQ0FBQztRQUNmLGlCQUFpQjtRQUNqQixJQUFJLGFBQWEsQ0FBQztRQUNsQixJQUFJLFNBQVMsQ0FBQztRQUNkLElBQUksUUFBUSxDQUFDO1FBQ2IsSUFBSSxhQUFhLENBQUM7UUFDbEIsSUFBSSxJQUFzQixDQUFDO1FBQzNCLElBQUksQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQzdCLFdBQVcsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDO1lBQzNGLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQzNCLFdBQVcsR0FBRyxTQUFTLENBQUM7YUFDM0I7WUFDRCxJQUFJLENBQUMsb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMs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Q0FBQyxLQUFLO1FBQ2QsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDdEYsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDN0MsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNqQixPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0NBQ0o7QUF0SUQsMEJBc0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VydmVyIH0gZnJvbSAnaHR0cCc7XG5pbXBvcnQgeyBidWlsZFByb3ZpZGVyTW9kdWxlIH0gZnJvbSAnaW52ZXJzaWZ5LWJpbmRpbmctZGVjb3JhdG9ycyc7XG5pbXBvcnQgeyBJbnZlcnNpZnlLb2FTZXJ2ZXIgfSBmcm9tICdpbnZlcnNpZnkta29hLXV0aWxzJztcbmltcG9ydCB7IE1pZGRsZXdhcmUgfSBmcm9tICdrb2EnO1xuaW1wb3J0ICogYXMgYm9keVBhcnNlciBmcm9tICdrb2EtYm9keXBhcnNlcic7XG5pbXBvcnQgKiBhcyBqd3QgZnJvbSAna29hLWp3dCc7XG5pbXBvcnQgKiBhcyBsb2c0anMgZnJvbSAna29hLWxvZzQnO1xuLy8gaW1wb3J0ICogYXMgbXVsdGVyIGZyb20gJ2tvYS1tdWx0ZXInO1xuaW1wb3J0ICogYXMgUm91dGVyIGZyb20gJ2tvYS1yb3V0ZXInO1xuaW1wb3J0ICogYXMgY29ycyBmcm9tICdrb2EyLWNvcnMnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICogYXMgZGVmQ29uZmlnIGZyb20gJy4vY29uZmlnL2RlZmNvbmZpZyc7XG5pbXBvcnQgeyBjb250YWluZXIgfSBmcm9tICcuL2lvYy9pb2MnO1xuaW1wb3J0IElvY1RyYWNlciBmcm9tICcuL2lvYy9pb2NUcmFjZXInO1xuaW1wb3J0IGtvYUxvZzRqcyBmcm9tICcuL21pZGRsZXdhcmVzL2xvZ2dlci9sb2c0anMnO1xuaW1wb3J0IHsgT1JNQ29udGV4dCB9IGZyb20gJy4vbW9kZWxzJztcbmltcG9ydCBHYW1hUmVzcG9uc2UgZnJvbSAnLi9tb2RlbHMvQmFzZVJlc3BvbnNlJztcbmltcG9ydCBIdHRwSW5pdFNldHRpbmcgZnJvbSAnLi9tb2RlbHMvSHR0cEluaXRTZXR0aW5nJztcbmltcG9ydCBJU2VydmVySW5pdE9uY2VFdmVudCBmcm9tICcuL1NlcnZlckV2ZW50L1NlcnZlckluaXRPbmNlRXZlbnQnO1xuXG5jb25zdCBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCdHU2VydmVyJyk7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHU2VydmVyIHtcbiAgICBwcml2YXRlIG1haW46IFByb21pc2U8YW55PjtcbiAgICBwcml2YXRlIHNlcnZlckluaXRPbmNlRXZlbnRzOiBJU2VydmVySW5pdE9uY2VFdmVudFtdIHwgdW5kZWZpbmVkO1xuICAgIHByaXZhdGUga29hU2VydmVyOiBTZXJ2ZXI7XG4gICAgY29uc3RydWN0b3IoaW5pdFNldHRpbmc6IEh0dHBJbml0U2V0dGluZykge1xuICAgICAgICBsZXQgbWlkZGxld2FyZXM7XG4gICAgICAgIGxldCBkb21haW5OYW1lO1xuICAgICAgICAvLyBsZXQgbXFTZXR0aW5nO1xuICAgICAgICBsZXQgand0UHJpdmF0ZUtleTtcbiAgICAgICAgbGV0IGp3dEFjdGl2ZTtcbiAgICAgICAgbGV0IGh0dHBQb3J0O1xuICAgICAgICBsZXQgY29yc1doaXRlbGlzdDtcbiAgICAgICAgbGV0IGxvZzQ6ICgpID0+IE1pZGRsZXdhcmU7XG4gICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZykpIHtcbiAgICAgICAgICAgIG1pZGRsZXdhcmVzID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5taWRkbGV3YXJlcykgPyB1bmRlZmluZWQgOiBpbml0U2V0dGluZy5taWRkbGV3YXJlcztcbiAgICAgICAgICAgIGlmIChfLnNpemUobWlkZGxld2FyZXMpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZXMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNlcnZlckluaXRPbmNlRXZlbnRzID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5pbmlEYXRhKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLmluaURhdGE7XG4gICAgICAgICAgICBjb3JzV2hpdGVsaXN0ID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5jb3JzV2hpdGVsaXN0KSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLmNvcnNXaGl0ZWxpc3Q7XG4gICAgICAgICAgICBkb21haW5OYW1lID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5kb21haW5OYW1lKSA/IHVuZGVmaW5lZCA6IGluaXRTZXR0aW5nLmRvbWFpbk5hbWU7XG4gICAgICAgICAgICAvLyBtcVNldHRpbmcgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLm1xU2V0dGluZykgPyB1bmRlZmluZWQgOiBpbml0U2V0dGluZy5tcVNldHRpbmc7XG4gICAgICAgICAgICBqd3RQcml2YXRlS2V5ID0gXy5pc1VuZGVmaW5lZChpbml0U2V0dGluZy5qd3RQcml2YXRlS2V5KSA/XG4gICAgICAgICAgICAgICAgZGVmQ29uZmlnLmp3dC5wcml2YXRlS2V5IDogaW5pdFNldHRpbmcuand0UHJpdmF0ZUtleTtcbiAgICAgICAgICAgIGp3dEFjdGl2ZSA9IF8uaXNVbmRlZmluZWQoaW5pdFNldHRpbmcuand0QWN0aXZlKSA/IGRlZkNvbmZpZy5qd3QuYWN0aXZlIDogaW5pdFNldHRpbmcuand0QWN0aXZlO1xuICAgICAgICAgICAgaHR0cFBvcnQgPSBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLmh0dHBQb3J0KSA/IGRlZkNvbmZpZy5odHRwUG9ydCA6IGluaXRTZXR0aW5nLmh0dHBQb3J0O1xuICAgICAgICAgICAgbG9nNCA9IF8uaXNGdW5jdGlvbihpbml0U2V0dGluZy5sb2c0KSA/IGtvYUxvZzRqcyA6IGluaXRTZXR0aW5nLmxvZzQhO1xuICAgICAgICAgICAgY29udGFpbmVyLmxvYWQoYnVpbGRQcm92aWRlck1vZHVsZSgpKTtcbiAgICAgICAgICAgIGlmIChpbml0U2V0dGluZy5maWx0ZXJzT3Blbikge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlvY1RyYWNlciA9IG5ldyBJb2NUcmFjZXIoaW5pdFNldHRpbmcuZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgaW9jVHJhY2VyLmFwcGx5KGNvbnRhaW5lcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tYWluID0gT1JNQ29udGV4dC5pbml0KGluaXRTZXR0aW5nLnBhdGhkYiwgaW5pdFNldHRpbmcucGF0aEJlYW5zUGF0aCk7XG4gICAgICAgIC8vIGNhZWF0ZSBEQiBjb25uZWN0aW9uXG4gICAgICAgIC8vIOmChOS4jeacg+eUqOWIsG1x5oeJ6Kmy6YKE5LiN6ZyA6KaB5Y676K6T5LuW5LiA55u05ZiX6Kmm6YCj57eaXG4gICAgICAgIC8vIGlmICghXy5pc1VuZGVmaW5lZChtcVNldHRpbmcpKSB7XG4gICAgICAgIC8vIHRoaXMubWFpbi50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW51bGwta2V5d29yZFxuICAgICAgICAvLyByZXR1cm4gbXEobnVsbCwgbXFTZXR0aW5nKTsgLy8gY29ubmVjdCBNUSBTZXJ2ZXJcbiAgICAgICAgLy8gfSk7XG4gICAgICAgIC8vIH1cbiAgICAgICAgdGhpcy5tYWluLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgcm9vdFJvdXRlciA9IG5ldyBSb3V0ZXIoe1xuICAgICAgICAgICAgICAgIHByZWZpeDogXy5pc1VuZGVmaW5lZChkb21haW5OYW1lKSA/ICcnIDogZG9tYWluTmFtZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBjcmVhdGUgc2VydmVyXG4gICAgICAgICAgICBjb25zdCBzZXJ2ZXIgPSBuZXcgSW52ZXJzaWZ5S29hU2VydmVyKGNvbnRhaW5lciwgcm9vdFJvdXRlcik7XG4gICAgICAgICAgICBzZXJ2ZXJcbiAgICAgICAgICAgICAgICAuc2V0Q29uZmlnKChhcHApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnVzZShhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIGNoZWNrIHVzZXIgYXV0aCB0byBvcGVyYXRlIGZ1bmN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IEdhbWFSZXNwb25zZShlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzQXJyYXkgPSBfLm1hcChfLnRvU3RyaW5nKGVyci5zdGF0dXMpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5zaXplKHN0YXR1c0FycmF5KSA9PT0gNCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNBcnJheVswXSBpbiBbJzgnLCAnOScsICc3JywgJzYnLCAnNScsICc0JywgJzMnLCAnMicsICcxJywgJzAnXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyDpgJnpgoptYXDmmK/lm6DngrropoHmipPlj5bnrKzkuIDlgIvmlbjlrZfplovpoK3nrYnmlrw55bCx5pyD6LeRZXJyb3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1c0FycmF5WzBdID09PSAnOScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlcnIuc3RhdHVzLCBlcnIubWVzc2FnZSwgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy53YXJuKGVyci5zdGF0dXMsIGVyci5tZXNzYWdlLCBKU09OLnN0cmluZ2lmeShjdHguc3RhdGUudXNlcikgfHwgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLiRzdGF0dXMgPSBlcnIuc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdGF0dXMgPSBlcnIuc3RhdHVzIHx8IDUwMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGVyci5zdGFjaywgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuJHN0YXR1cyA9IGN0eC5zdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hcHAuZW1pdCgnZXJyb3InLCBlcnIsIGN0eCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJvZHkgPSByZXNwb25zZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC51c2UoY29ycyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiAoY3R4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGNvcnNXaGl0ZWxpc3QpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLnNpemUoY29yc1doaXRlbGlzdCkgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnKic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXy5pbmNsdWRlcyhjb3JzV2hpdGVsaXN0LCBjdHguaGVhZGVyLm9yaWdpbikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnKic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguc3RhdHVzID0gNDA0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KDQyMiwgbmV3IEVycm9yKCdOb3QgQWxsb3cgQ29ycycpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnVzZShsb2c0KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAudXNlKG11bHRlcih7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgc3RvcmFnZTogbXVsdGVyLm1lbW9yeVN0b3JhZ2UoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gfSkuYW55KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAudXNlKGJvZHlQYXJzZXIoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmljdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25lcnJvcjogKGVyciwgY3R4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgudGhyb3coNDIyLCBuZXcgRXJyb3IoJ2JvZHkgcGFyc2UgZXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQobWlkZGxld2FyZXMpICYmIF8uc2l6ZShtaWRkbGV3YXJlcykgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChtaWRkbGV3YXJlcywgKG1pZGRsZXdhcmUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAudXNlKG1pZGRsZXdhcmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXBwLnVzZShqd3QoeyBzZWNyZXQ6IGp3dFByaXZhdGVLZXksIHBhc3N0aHJvdWdoOiAhand0QWN0aXZlIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudW5sZXNzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiBfLmlzVW5kZWZpbmVkKGluaXRTZXR0aW5nLnVubGVzc1BhdGgpID8gW10gOiBpbml0U2V0dGluZy51bmxlc3NQYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuc2V0RXJyb3JDb25maWcoKGFwcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhcHAudXNlKChjdHgsIG5leHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihjdHguc3RhdHVzLCBjdHgubWVzc2FnZSwgSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlLnVzZXIpIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLmtvYVNlcnZlciA9IHNlcnZlci5idWlsZCgpLmxpc3RlbihodHRwUG9ydCk7XG4gICAgICAgICAgICBsb2cuaW5mbygnSHR0cCBzdGFydGVkIGxpc3RlbmluZyBvbiBodHRwOi8vbG9jYWxob3N0OiVzIC4uLicsIGh0dHBQb3J0KTtcbiAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICBwdWJsaWMgYXN5bmMgc3RhcnQoKSB7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFt0aGlzLm1haW5dKTtcbiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMpICYmIF8uc2l6ZSh0aGlzLnNlcnZlckluaXRPbmNlRXZlbnRzKSAhPT0gMCkge1xuICAgICAgICAgICAgXy5mb3JFYWNoKHRoaXMuc2VydmVySW5pdE9uY2VFdmVudHMsIChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZWxlbWVudC5kb09uY2UoKTtcbiAgICAgICAgICAgICAgICBlbGVtZW50LmVuZCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMua29hU2VydmVyO1xuICAgIH1cbn1cbiJdfQ==