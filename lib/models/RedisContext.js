"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const IORedis = require("ioredis");
const log4js = require("koa-log4");
const BaseUtils_1 = require("../utils/BaseUtils");
const log = log4js.getLogger('RedisContext');
class RedisContext {
    constructor() { }
    static async initialize(jsonConfig) {
        RedisContext.instance.redis = new IORedis(jsonConfig.port, jsonConfig.host, {
            dropBufferSupport: true,
            enableReadyCheck: true,
            stringNumbers: true
        });
        const changePromis = RedisContext.instance.redis;
        changePromis.Promise = global.Promise;
        IORedis.Command.setArgumentTransformer('hmset', (args) => {
            if (args.length === 2) {
                if (typeof Map !== 'undefined' && args[1] instanceof Map) {
                    // utils is a internal module of ioredis
                    return [args[0]].concat(BaseUtils_1.default.convertMapToArray(args[1]));
                }
                if (typeof args[1] === 'object' && args[1] !== null) {
                    return [args[0]].concat(BaseUtils_1.default.convertObjectToArray(args[1]));
                }
            }
            return args;
        });
        IORedis.Command.setReplyTransformer('hgetall', (result) => {
            if (Array.isArray(result)) {
                const obj = {};
                for (let i = 0; i < result.length; i += 2) {
                    obj[result[i]] = result[i + 1];
                }
                return obj;
            }
            return result;
        });
        IORedis.Command.setReplyTransformer('exec', (result) => {
            if (Array.isArray(result)) {
                let length = result.length;
                const finalData = [];
                while (length--) {
                    const error = result[length][0];
                    if (error) {
                        log.error('redis.exec() error: ' + error);
                        throw error;
                    }
                    finalData.push(result[length][1]);
                }
                return finalData;
            }
            return result;
        });
        log.info(`RedisContext is ready.`);
    }
    static async initializeCluster(jsonConfig) {
        RedisContext.instance.redis = new IORedis.Cluster(jsonConfig, {
            enableReadyCheck: true,
            clusterRetryStrategy: (times) => {
                return Math.min(100 + times * 2, 2000);
            },
            scaleReads: 'all',
            redisOptions: {
                dropBufferSupport: true,
                enableReadyCheck: true,
                stringNumbers: true
            }
        });
        const changePromis = RedisContext.instance.redis;
        changePromis.Promise = global.Promise;
        RedisContext.instance.allAll = RedisContext.instance.redis.nodes('all');
        RedisContext.instance.allSlaves = RedisContext.instance.redis.nodes('slave');
        RedisContext.instance.allMasters = RedisContext.instance.redis.nodes('master');
        IORedis.Command.setArgumentTransformer('hmset', (args) => {
            if (args.length === 2) {
                if (typeof Map !== 'undefined' && args[1] instanceof Map) {
                    // utils is a internal module of ioredis
                    return [args[0]].concat(BaseUtils_1.default.convertMapToArray(args[1]));
                }
                if (typeof args[1] === 'object' && args[1] !== null) {
                    return [args[0]].concat(BaseUtils_1.default.convertObjectToArray(args[1]));
                }
            }
            return args;
        });
        IORedis.Command.setReplyTransformer('hgetall', (result) => {
            if (Array.isArray(result)) {
                const obj = {};
                for (let i = 0; i < result.length; i += 2) {
                    obj[result[i]] = result[i + 1];
                }
                return obj;
            }
            return result;
        });
        log.info(`RedisContext is ready.`);
    }
    static getInstance() {
        return RedisContext.instance;
    }
    getRedis() {
        return RedisContext.instance.redis;
    }
    getAllNode() {
        return RedisContext.instance.allAll;
    }
    getallMasters() {
        return RedisContext.instance.allMasters;
    }
    getallSlaves() {
        return RedisContext.instance.allSlaves;
    }
}
RedisContext.instance = new RedisContext();
exports.default = RedisContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVkaXNDb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii4vc3JjLyIsInNvdXJjZXMiOlsibW9kZWxzL1JlZGlzQ29udGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUFtQztBQUNuQyxtQ0FBbUM7QUFFbkMsa0RBQTJDO0FBRTNDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDN0MsTUFBcUIsWUFBWTtJQW9HN0IsZ0JBQXdCLENBQUM7SUE1RmxCLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLFVBQTBDO1FBQ3JFLFlBQVksQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLElBQUksT0FBTyxDQUNyQyxVQUFVLENBQUMsSUFBSSxFQUNmLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDYixpQkFBaUIsRUFBRSxJQUFJO1lBQ3ZCLGdCQUFnQixFQUFFLElBQUk7WUFDdEIsYUFBYSxFQUFFLElBQUk7U0FDZixDQUFDLENBQUM7UUFDZCxNQUFNLFlBQVksR0FBUSxZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUN0RCxZQUFZLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFDdEMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNyRCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNuQixJQUFJLE9BQU8sR0FBRyxLQUFLLFdBQVcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksR0FBRyxFQUFFO29CQUN0RCx3Q0FBd0M7b0JBQ3hDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsbUJBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNqRTtnQkFDRCxJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxFQUFFO29CQUNqRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLG1CQUFTLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDcEU7YUFDSjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUN0RCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3ZCLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztnQkFDZixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUN2QyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDbEM7Z0JBQ0QsT0FBTyxHQUFHLENBQUM7YUFDZDtZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUNuRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3ZCLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQzNCLE1BQU0sU0FBUyxHQUFVLEVBQUUsQ0FBQztnQkFDNUIsT0FBTyxNQUFNLEVBQUUsRUFBRTtvQkFDYixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2hDLElBQUksS0FBSyxFQUFFO3dCQUNQLEdBQUcsQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEdBQUcsS0FBSyxDQUFDLENBQUM7d0JBQzFDLE1BQU0sS0FBSyxDQUFDO3FCQUNmO29CQUNELFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ3JDO2dCQUNELE9BQU8sU0FBUyxDQUFDO2FBQ3BCO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUM7UUFDSCxHQUFHLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUNNLE1BQU0sQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsVUFBaUM7UUFDbkUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRTtZQUMxRCxnQkFBZ0IsRUFBRSxJQUFJO1lBQ3RCLG9CQUFvQixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7Z0JBQzVCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsS0FBSyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMzQyxDQUFDO1lBQ0QsVUFBVSxFQUFFLEtBQUs7WUFDakIsWUFBWSxFQUFFO2dCQUNWLGlCQUFpQixFQUFFLElBQUk7Z0JBQ3ZCLGdCQUFnQixFQUFFLElBQUk7Z0JBQ3RCLGFBQWEsRUFBRSxJQUFJO2FBQ2Y7U0FDWCxDQUFRLENBQUM7UUFDVixNQUFNLFlBQVksR0FBUSxZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUN0RCxZQUFZLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFDdEMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hFLFlBQVksQ0FBQyxRQUFRLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM3RSxZQUFZLENBQUMsUUFBUSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0UsT0FBTyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNyRCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNuQixJQUFJLE9BQU8sR0FBRyxLQUFLLFdBQVcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksR0FBRyxFQUFFO29CQUN0RCx3Q0FBd0M7b0JBQ3hDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsbUJBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNqRTtnQkFDRCxJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxFQUFFO29CQUNqRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLG1CQUFTLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDcEU7YUFDSjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUN0RCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3ZCLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztnQkFDZixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUN2QyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDbEM7Z0JBQ0QsT0FBTyxHQUFHLENBQUM7YUFDZDtZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFHTSxNQUFNLENBQUMsV0FBVztRQUNyQixPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUM7SUFDakMsQ0FBQztJQUVNLFFBQVE7UUFDWCxPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO0lBQ3ZDLENBQUM7SUFFTSxVQUFVO1FBQ2IsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztJQUN4QyxDQUFDO0lBRU0sYUFBYTtRQUNoQixPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDO0lBQzVDLENBQUM7SUFFTSxZQUFZO1FBQ2YsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQztJQUMzQyxDQUFDOztBQXRIYyxxQkFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFGakQsK0JBeUhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgSU9SZWRpcyBmcm9tICdpb3JlZGlzJztcbmltcG9ydCAqIGFzIGxvZzRqcyBmcm9tICdrb2EtbG9nNCc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQmFzZVV0aWxzIGZyb20gJy4uL3V0aWxzL0Jhc2VVdGlscyc7XG5cbmNvbnN0IGxvZyA9IGxvZzRqcy5nZXRMb2dnZXIoJ1JlZGlzQ29udGV4dCcpO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVkaXNDb250ZXh0IHtcblxuICAgIHByaXZhdGUgc3RhdGljIGluc3RhbmNlID0gbmV3IFJlZGlzQ29udGV4dCgpO1xuICAgIHByaXZhdGUgcmVkaXM6IGFueTtcbiAgICBwcml2YXRlIGFsbE1hc3RlcnM6IElPUmVkaXMuUmVkaXNbXTtcbiAgICBwcml2YXRlIGFsbFNsYXZlczogSU9SZWRpcy5SZWRpc1tdO1xuICAgIHByaXZhdGUgYWxsQWxsOiBJT1JlZGlzLlJlZGlzW107XG5cbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGluaXRpYWxpemUoanNvbkNvbmZpZzogeyBwb3J0OiBudW1iZXIsIGhvc3Q6IHN0cmluZyB9KSB7XG4gICAgICAgIFJlZGlzQ29udGV4dC5pbnN0YW5jZS5yZWRpcyA9IG5ldyBJT1JlZGlzKFxuICAgICAgICAgICAganNvbkNvbmZpZy5wb3J0LFxuICAgICAgICAgICAganNvbkNvbmZpZy5ob3N0LCB7XG4gICAgICAgICAgICAgICAgZHJvcEJ1ZmZlclN1cHBvcnQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZW5hYmxlUmVhZHlDaGVjazogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzdHJpbmdOdW1iZXJzOiB0cnVlXG4gICAgICAgICAgICB9IGFzIGFueSk7XG4gICAgICAgIGNvbnN0IGNoYW5nZVByb21pczogYW55ID0gUmVkaXNDb250ZXh0Lmluc3RhbmNlLnJlZGlzO1xuICAgICAgICBjaGFuZ2VQcm9taXMuUHJvbWlzZSA9IGdsb2JhbC5Qcm9taXNlO1xuICAgICAgICBJT1JlZGlzLkNvbW1hbmQuc2V0QXJndW1lbnRUcmFuc2Zvcm1lcignaG1zZXQnLCAoYXJncykgPT4ge1xuICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNYXAgIT09ICd1bmRlZmluZWQnICYmIGFyZ3NbMV0gaW5zdGFuY2VvZiBNYXApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gdXRpbHMgaXMgYSBpbnRlcm5hbCBtb2R1bGUgb2YgaW9yZWRpc1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2FyZ3NbMF1dLmNvbmNhdChCYXNlVXRpbHMuY29udmVydE1hcFRvQXJyYXkoYXJnc1sxXSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMV0gPT09ICdvYmplY3QnICYmIGFyZ3NbMV0gIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFthcmdzWzBdXS5jb25jYXQoQmFzZVV0aWxzLmNvbnZlcnRPYmplY3RUb0FycmF5KGFyZ3NbMV0pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYXJncztcbiAgICAgICAgfSk7XG4gICAgICAgIElPUmVkaXMuQ29tbWFuZC5zZXRSZXBseVRyYW5zZm9ybWVyKCdoZ2V0YWxsJywgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9iaiA9IHt9O1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSArPSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIG9ialtyZXN1bHRbaV1dID0gcmVzdWx0W2kgKyAxXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgICAgICBJT1JlZGlzLkNvbW1hbmQuc2V0UmVwbHlUcmFuc2Zvcm1lcignZXhlYycsIChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICBsZXQgbGVuZ3RoID0gcmVzdWx0Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICBjb25zdCBmaW5hbERhdGE6IGFueVtdID0gW107XG4gICAgICAgICAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gcmVzdWx0W2xlbmd0aF1bMF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKCdyZWRpcy5leGVjKCkgZXJyb3I6ICcgKyBlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmaW5hbERhdGEucHVzaChyZXN1bHRbbGVuZ3RoXVsxXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmaW5hbERhdGE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICAgICAgbG9nLmluZm8oYFJlZGlzQ29udGV4dCBpcyByZWFkeS5gKTtcbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBpbml0aWFsaXplQ2x1c3Rlcihqc29uQ29uZmlnOiBJT1JlZGlzLkNsdXN0ZXJOb2RlW10pIHtcbiAgICAgICAgUmVkaXNDb250ZXh0Lmluc3RhbmNlLnJlZGlzID0gbmV3IElPUmVkaXMuQ2x1c3Rlcihqc29uQ29uZmlnLCB7XG4gICAgICAgICAgICBlbmFibGVSZWFkeUNoZWNrOiB0cnVlLFxuICAgICAgICAgICAgY2x1c3RlclJldHJ5U3RyYXRlZ3k6ICh0aW1lcykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbigxMDAgKyB0aW1lcyAqIDIsIDIwMDApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNjYWxlUmVhZHM6ICdhbGwnLFxuICAgICAgICAgICAgcmVkaXNPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgZHJvcEJ1ZmZlclN1cHBvcnQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZW5hYmxlUmVhZHlDaGVjazogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzdHJpbmdOdW1iZXJzOiB0cnVlXG4gICAgICAgICAgICB9IGFzIGFueVxuICAgICAgICB9KSBhcyBhbnk7XG4gICAgICAgIGNvbnN0IGNoYW5nZVByb21pczogYW55ID0gUmVkaXNDb250ZXh0Lmluc3RhbmNlLnJlZGlzO1xuICAgICAgICBjaGFuZ2VQcm9taXMuUHJvbWlzZSA9IGdsb2JhbC5Qcm9taXNlO1xuICAgICAgICBSZWRpc0NvbnRleHQuaW5zdGFuY2UuYWxsQWxsID0gUmVkaXNDb250ZXh0Lmluc3RhbmNlLnJlZGlzLm5vZGVzKCdhbGwnKTtcbiAgICAgICAgUmVkaXNDb250ZXh0Lmluc3RhbmNlLmFsbFNsYXZlcyA9IFJlZGlzQ29udGV4dC5pbnN0YW5jZS5yZWRpcy5ub2Rlcygnc2xhdmUnKTtcbiAgICAgICAgUmVkaXNDb250ZXh0Lmluc3RhbmNlLmFsbE1hc3RlcnMgPSBSZWRpc0NvbnRleHQuaW5zdGFuY2UucmVkaXMubm9kZXMoJ21hc3RlcicpO1xuICAgICAgICBJT1JlZGlzLkNvbW1hbmQuc2V0QXJndW1lbnRUcmFuc2Zvcm1lcignaG1zZXQnLCAoYXJncykgPT4ge1xuICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNYXAgIT09ICd1bmRlZmluZWQnICYmIGFyZ3NbMV0gaW5zdGFuY2VvZiBNYXApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gdXRpbHMgaXMgYSBpbnRlcm5hbCBtb2R1bGUgb2YgaW9yZWRpc1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2FyZ3NbMF1dLmNvbmNhdChCYXNlVXRpbHMuY29udmVydE1hcFRvQXJyYXkoYXJnc1sxXSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMV0gPT09ICdvYmplY3QnICYmIGFyZ3NbMV0gIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFthcmdzWzBdXS5jb25jYXQoQmFzZVV0aWxzLmNvbnZlcnRPYmplY3RUb0FycmF5KGFyZ3NbMV0pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYXJncztcbiAgICAgICAgfSk7XG4gICAgICAgIElPUmVkaXMuQ29tbWFuZC5zZXRSZXBseVRyYW5zZm9ybWVyKCdoZ2V0YWxsJywgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9iaiA9IHt9O1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSArPSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIG9ialtyZXN1bHRbaV1dID0gcmVzdWx0W2kgKyAxXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgICAgICBsb2cuaW5mbyhgUmVkaXNDb250ZXh0IGlzIHJlYWR5LmApO1xuICAgIH1cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKCkgeyB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldEluc3RhbmNlKCk6IFJlZGlzQ29udGV4dCB7XG4gICAgICAgIHJldHVybiBSZWRpc0NvbnRleHQuaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFJlZGlzKCk6IElPUmVkaXMuQ2x1c3RlciB7XG4gICAgICAgIHJldHVybiBSZWRpc0NvbnRleHQuaW5zdGFuY2UucmVkaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEFsbE5vZGUoKTogSU9SZWRpcy5SZWRpc1tdIHtcbiAgICAgICAgcmV0dXJuIFJlZGlzQ29udGV4dC5pbnN0YW5jZS5hbGxBbGw7XG4gICAgfVxuXG4gICAgcHVibGljIGdldGFsbE1hc3RlcnMoKTogSU9SZWRpcy5SZWRpc1tdIHtcbiAgICAgICAgcmV0dXJuIFJlZGlzQ29udGV4dC5pbnN0YW5jZS5hbGxNYXN0ZXJzO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRhbGxTbGF2ZXMoKTogSU9SZWRpcy5SZWRpc1tdIHtcbiAgICAgICAgcmV0dXJuIFJlZGlzQ29udGV4dC5pbnN0YW5jZS5hbGxTbGF2ZXM7XG4gICAgfVxufVxuIl19