"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const IORedis = require("ioredis");
const log4js = require("koa-log4");
const BaseUtils_1 = require("../utils/BaseUtils");
const log = log4js.getLogger('RedisContext');
class RedisContext {
    constructor() { }
    static async initialize(jsonConfig) {
        RedisContext.instance.redis = new IORedis(jsonConfig.port, jsonConfig.host, {
            dropBufferSupport: true,
            enableReadyCheck: true,
            stringNumbers: true
        });
        const changePromis = RedisContext.instance.redis;
        changePromis.Promise = global.Promise;
        IORedis.Command.setArgumentTransformer('hmset', (args) => {
            if (args.length === 2) {
                if (typeof Map !== 'undefined' && args[1] instanceof Map) {
                    // utils is a internal module of ioredis
                    return [args[0]].concat(BaseUtils_1.default.convertMapToArray(args[1]));
                }
                if (typeof args[1] === 'object' && args[1] !== null) {
                    return [args[0]].concat(BaseUtils_1.default.convertObjectToArray(args[1]));
                }
            }
            return args;
        });
        IORedis.Command.setReplyTransformer('hgetall', (result) => {
            if (Array.isArray(result)) {
                const obj = {};
                for (let i = 0; i < result.length; i += 2) {
                    obj[result[i]] = result[i + 1];
                }
                return obj;
            }
            return result;
        });
        IORedis.Command.setReplyTransformer('exec', (result) => {
            if (Array.isArray(result)) {
                const size = result.length;
                const finalData = [];
                for (let index = 0; index < size; index++) {
                    const error = result[index][0];
                    if (error) {
                        log.error('redis.exec() error: ' + error);
                        throw error;
                    }
                    finalData.push(result[index][1]);
                }
                return finalData;
            }
            return result;
        });
        log.info(`RedisContext is ready.`);
    }
    static async initializeCluster(jsonConfig) {
        RedisContext.instance.redis = new IORedis.Cluster(jsonConfig, {
            enableReadyCheck: true,
            clusterRetryStrategy: (times) => {
                return Math.min(100 + times * 2, 2000);
            },
            scaleReads: 'all',
            redisOptions: {
                dropBufferSupport: true,
                enableReadyCheck: true,
                stringNumbers: true
            }
        });
        const changePromis = RedisContext.instance.redis;
        changePromis.Promise = global.Promise;
        RedisContext.instance.allAll = RedisContext.instance.redis.nodes('all');
        RedisContext.instance.allSlaves = RedisContext.instance.redis.nodes('slave');
        RedisContext.instance.allMasters = RedisContext.instance.redis.nodes('master');
        IORedis.Command.setArgumentTransformer('hmset', (args) => {
            if (args.length === 2) {
                if (typeof Map !== 'undefined' && args[1] instanceof Map) {
                    // utils is a internal module of ioredis
                    return [args[0]].concat(BaseUtils_1.default.convertMapToArray(args[1]));
                }
                if (typeof args[1] === 'object' && args[1] !== null) {
                    return [args[0]].concat(BaseUtils_1.default.convertObjectToArray(args[1]));
                }
            }
            return args;
        });
        IORedis.Command.setReplyTransformer('hgetall', (result) => {
            if (Array.isArray(result)) {
                const obj = {};
                for (let i = 0; i < result.length; i += 2) {
                    obj[result[i]] = result[i + 1];
                }
                return obj;
            }
            return result;
        });
        log.info(`RedisContext is ready.`);
    }
    static getInstance() {
        return RedisContext.instance;
    }
    getRedis() {
        return RedisContext.instance.redis;
    }
    getAllNode() {
        return RedisContext.instance.allAll;
    }
    getallMasters() {
        return RedisContext.instance.allMasters;
    }
    getallSlaves() {
        return RedisContext.instance.allSlaves;
    }
}
RedisContext.instance = new RedisContext();
exports.default = RedisContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVkaXNDb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii4vc3JjLyIsInNvdXJjZXMiOlsibW9kZWxzL1JlZGlzQ29udGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUFtQztBQUNuQyxtQ0FBbUM7QUFFbkMsa0RBQTJDO0FBRTNDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDN0MsTUFBcUIsWUFBWTtJQW9HN0IsZ0JBQXdCLENBQUM7SUE1RmxCLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLFVBQTBDO1FBQ3JFLFlBQVksQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLElBQUksT0FBTyxDQUNyQyxVQUFVLENBQUMsSUFBSSxFQUNmLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDYixpQkFBaUIsRUFBRSxJQUFJO1lBQ3ZCLGdCQUFnQixFQUFFLElBQUk7WUFDdEIsYUFBYSxFQUFFLElBQUk7U0FDZixDQUFDLENBQUM7UUFDZCxNQUFNLFlBQVksR0FBUSxZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUN0RCxZQUFZLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFDdEMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNyRCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNuQixJQUFJLE9BQU8sR0FBRyxLQUFLLFdBQVcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksR0FBRyxFQUFFO29CQUN0RCx3Q0FBd0M7b0JBQ3hDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsbUJBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNqRTtnQkFDRCxJQUFJLE9BQU8sSUFB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QUcsR0FBRyxFQUFFLENBQUM7Z0JBQ2YsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDdkMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7aUJBQ2xDO2dCQUNELE9BQU8sR0FBRyxDQUFDO2FBQ2Q7WUFDRCxPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBR00sTUFBTSxDQUFDLFdBQVc7UUFDckIsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDO0lBQ2pDLENBQUM7SUFFTSxRQUFRO1FBQ1gsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztJQUN2QyxDQUFDO0lBRU0sVUFBVTtRQUNiLE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDeEMsQ0FBQztJQUVNLGFBQWE7UUFDaEIsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQztJQUM1QyxDQUFDO0lBRU0sWUFBWTtRQUNmLE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUM7SUFDM0MsQ0FBQzs7QUF0SGMscUJBQVEsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0FBRmpELCtCQXlIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIElPUmVkaXMgZnJvbSAnaW9yZWRpcyc7XG5pbXBvcnQgKiBhcyBsb2c0anMgZnJvbSAna29hLWxvZzQnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEJhc2VVdGlscyBmcm9tICcuLi91dGlscy9CYXNlVXRpbHMnO1xuXG5jb25zdCBsb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCdSZWRpc0NvbnRleHQnKTtcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlZGlzQ29udGV4dCB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZSA9IG5ldyBSZWRpc0NvbnRleHQoKTtcbiAgICBwcml2YXRlIHJlZGlzOiBhbnk7XG4gICAgcHJpdmF0ZSBhbGxNYXN0ZXJzOiBJT1JlZGlzLlJlZGlzW107XG4gICAgcHJpdmF0ZSBhbGxTbGF2ZXM6IElPUmVkaXMuUmVkaXNbXTtcbiAgICBwcml2YXRlIGFsbEFsbDogSU9SZWRpcy5SZWRpc1tdO1xuXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBpbml0aWFsaXplKGpzb25Db25maWc6IHsgcG9ydDogbnVtYmVyLCBob3N0OiBzdHJpbmcgfSkge1xuICAgICAgICBSZWRpc0NvbnRleHQuaW5zdGFuY2UucmVkaXMgPSBuZXcgSU9SZWRpcyhcbiAgICAgICAgICAgIGpzb25Db25maWcucG9ydCxcbiAgICAgICAgICAgIGpzb25Db25maWcuaG9zdCwge1xuICAgICAgICAgICAgICAgIGRyb3BCdWZmZXJTdXBwb3J0OiB0cnVlLFxuICAgICAgICAgICAgICAgIGVuYWJsZVJlYWR5Q2hlY2s6IHRydWUsXG4gICAgICAgICAgICAgICAgc3RyaW5nTnVtYmVyczogdHJ1ZVxuICAgICAgICAgICAgfSBhcyBhbnkpO1xuICAgICAgICBjb25zdCBjaGFuZ2VQcm9taXM6IGFueSA9IFJlZGlzQ29udGV4dC5pbnN0YW5jZS5yZWRpcztcbiAgICAgICAgY2hhbmdlUHJvbWlzLlByb21pc2UgPSBnbG9iYWwuUHJvbWlzZTtcbiAgICAgICAgSU9SZWRpcy5Db21tYW5kLnNldEFyZ3VtZW50VHJhbnNmb3JtZXIoJ2htc2V0JywgKGFyZ3MpID0+IHtcbiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTWFwICE9PSAndW5kZWZpbmVkJyAmJiBhcmdzWzFdIGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHV0aWxzIGlzIGEgaW50ZXJuYWwgbW9kdWxlIG9mIGlvcmVkaXNcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFthcmdzWzBdXS5jb25jYXQoQmFzZVV0aWxzLmNvbnZlcnRNYXBUb0FycmF5KGFyZ3NbMV0pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzFdID09PSAnb2JqZWN0JyAmJiBhcmdzWzFdICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbYXJnc1swXV0uY29uY2F0KEJhc2VVdGlscy5jb252ZXJ0T2JqZWN0VG9BcnJheShhcmdzWzFdKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFyZ3M7XG4gICAgICAgIH0pO1xuICAgICAgICBJT1JlZGlzLkNvbW1hbmQuc2V0UmVwbHlUcmFuc2Zvcm1lcignaGdldGFsbCcsIChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBvYmogPSB7fTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkgKz0gMikge1xuICAgICAgICAgICAgICAgICAgICBvYmpbcmVzdWx0W2ldXSA9IHJlc3VsdFtpICsgMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICAgICAgSU9SZWRpcy5Db21tYW5kLnNldFJlcGx5VHJhbnNmb3JtZXIoJ2V4ZWMnLCAocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IHJlc3VsdC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgY29uc3QgZmluYWxEYXRhOiBhbnlbXSA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBzaXplOyBpbmRleCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gcmVzdWx0W2luZGV4XVswXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoJ3JlZGlzLmV4ZWMoKSBlcnJvcjogJyArIGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZpbmFsRGF0YS5wdXNoKHJlc3VsdFtpbmRleF1bMV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZmluYWxEYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgICAgIGxvZy5pbmZvKGBSZWRpc0NvbnRleHQgaXMgcmVhZHkuYCk7XG4gICAgfVxuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgaW5pdGlhbGl6ZUNsdXN0ZXIoanNvbkNvbmZpZzogSU9SZWRpcy5DbHVzdGVyTm9kZVtdKSB7XG4gICAgICAgIFJlZGlzQ29udGV4dC5pbnN0YW5jZS5yZWRpcyA9IG5ldyBJT1JlZGlzLkNsdXN0ZXIoanNvbkNvbmZpZywge1xuICAgICAgICAgICAgZW5hYmxlUmVhZHlDaGVjazogdHJ1ZSxcbiAgICAgICAgICAgIGNsdXN0ZXJSZXRyeVN0cmF0ZWd5OiAodGltZXMpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5taW4oMTAwICsgdGltZXMgKiAyLCAyMDAwKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzY2FsZVJlYWRzOiAnYWxsJyxcbiAgICAgICAgICAgIHJlZGlzT3B0aW9uczoge1xuICAgICAgICAgICAgICAgIGRyb3BCdWZmZXJTdXBwb3J0OiB0cnVlLFxuICAgICAgICAgICAgICAgIGVuYWJsZVJlYWR5Q2hlY2s6IHRydWUsXG4gICAgICAgICAgICAgICAgc3RyaW5nTnVtYmVyczogdHJ1ZVxuICAgICAgICAgICAgfSBhcyBhbnlcbiAgICAgICAgfSkgYXMgYW55O1xuICAgICAgICBjb25zdCBjaGFuZ2VQcm9taXM6IGFueSA9IFJlZGlzQ29udGV4dC5pbnN0YW5jZS5yZWRpcztcbiAgICAgICAgY2hhbmdlUHJvbWlzLlByb21pc2UgPSBnbG9iYWwuUHJvbWlzZTtcbiAgICAgICAgUmVkaXNDb250ZXh0Lmluc3RhbmNlLmFsbEFsbCA9IFJlZGlzQ29udGV4dC5pbnN0YW5jZS5yZWRpcy5ub2RlcygnYWxsJyk7XG4gICAgICAgIFJlZGlzQ29udGV4dC5pbnN0YW5jZS5hbGxTbGF2ZXMgPSBSZWRpc0NvbnRleHQuaW5zdGFuY2UucmVkaXMubm9kZXMoJ3NsYXZlJyk7XG4gICAgICAgIFJlZGlzQ29udGV4dC5pbnN0YW5jZS5hbGxNYXN0ZXJzID0gUmVkaXNDb250ZXh0Lmluc3RhbmNlLnJlZGlzLm5vZGVzKCdtYXN0ZXInKTtcbiAgICAgICAgSU9SZWRpcy5Db21tYW5kLnNldEFyZ3VtZW50VHJhbnNmb3JtZXIoJ2htc2V0JywgKGFyZ3MpID0+IHtcbiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTWFwICE9PSAndW5kZWZpbmVkJyAmJiBhcmdzWzFdIGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHV0aWxzIGlzIGEgaW50ZXJuYWwgbW9kdWxlIG9mIGlvcmVkaXNcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFthcmdzWzBdXS5jb25jYXQoQmFzZVV0aWxzLmNvbnZlcnRNYXBUb0FycmF5KGFyZ3NbMV0pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzFdID09PSAnb2JqZWN0JyAmJiBhcmdzWzFdICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbYXJnc1swXV0uY29uY2F0KEJhc2VVdGlscy5jb252ZXJ0T2JqZWN0VG9BcnJheShhcmdzWzFdKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFyZ3M7XG4gICAgICAgIH0pO1xuICAgICAgICBJT1JlZGlzLkNvbW1hbmQuc2V0UmVwbHlUcmFuc2Zvcm1lcignaGdldGFsbCcsIChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBvYmogPSB7fTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkgKz0gMikge1xuICAgICAgICAgICAgICAgICAgICBvYmpbcmVzdWx0W2ldXSA9IHJlc3VsdFtpICsgMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICAgICAgbG9nLmluZm8oYFJlZGlzQ29udGV4dCBpcyByZWFkeS5gKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRJbnN0YW5jZSgpOiBSZWRpc0NvbnRleHQge1xuICAgICAgICByZXR1cm4gUmVkaXNDb250ZXh0Lmluc3RhbmNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRSZWRpcygpOiBJT1JlZGlzLkNsdXN0ZXIge1xuICAgICAgICByZXR1cm4gUmVkaXNDb250ZXh0Lmluc3RhbmNlLnJlZGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRBbGxOb2RlKCk6IElPUmVkaXMuUmVkaXNbXSB7XG4gICAgICAgIHJldHVybiBSZWRpc0NvbnRleHQuaW5zdGFuY2UuYWxsQWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRhbGxNYXN0ZXJzKCk6IElPUmVkaXMuUmVkaXNbXSB7XG4gICAgICAgIHJldHVybiBSZWRpc0NvbnRleHQuaW5zdGFuY2UuYWxsTWFzdGVycztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0YWxsU2xhdmVzKCk6IElPUmVkaXMuUmVkaXNbXSB7XG4gICAgICAgIHJldHVybiBSZWRpc0NvbnRleHQuaW5zdGFuY2UuYWxsU2xhdmVzO1xuICAgIH1cbn1cbiJdfQ==