"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const inversify_tracer_1 = require("inversify-tracer");
require("reflect-metadata");
const log4js = require("koa-log4");
const _ = require("lodash");
const EnumTracerconfig_1 = require("../config/EnumTracerconfig");
const AnyEntity_1 = require("../models/AnyEntity");
const BaseEntity_1 = require("../models/BaseEntity");
const BaseUtils_1 = require("../utils/BaseUtils");
const _log = log4js.getLogger('Tracer');
const LOG_TOO_BIG = 5;
const STRING_TOO_BIG = 100;
const OBJ_TOO_BIG = 15;
const SIZE_TOO_BIG = 10;
const autoParse = (obj) => {
    if (_.isBuffer(obj)) {
        return '<BUFFER '
            + _.take(obj, LOG_TOO_BIG) + 'More ' + (_.size(obj) - LOG_TOO_BIG) + '.items>';
    }
    else if (_.isString(obj)) {
        return _.truncate(obj, {
            length: STRING_TOO_BIG,
            omission: ' <StringTooBig...>'
        });
    }
    else if (_.isNumber(obj)) {
        return obj;
    }
    else if (_.isDate(obj)) {
        return BaseUtils_1.default.DBTimeFormat(obj);
    }
    else if (obj instanceof BaseEntity_1.default) {
        return _.mapValues(obj.toJSON(), (v) => {
            if (_.isBuffer(v)) {
                return '<BUFFER '
                    + _.take(v, LOG_TOO_BIG) + 'More ' + (_.size(v) - LOG_TOO_BIG) + '.items>';
            }
            else if (_.isString(v)) {
                return _.truncate(v, {
                    length: STRING_TOO_BIG,
                    omission: ' <StringTooBig...>'
                });
            }
            else if (_.isNumber(v)) {
                return v;
            }
            else if (_.isDate(v)) {
                return BaseUtils_1.default.DBTimeFormat(v);
            }
            else if (_.size(v) > LOG_TOO_BIG) {
                return '<TOO-BIG-DATA '
                    + _.take(v, LOG_TOO_BIG) + 'More ' + (_.size(v) - LOG_TOO_BIG) + '.items>';
            }
            else {
                return v;
            }
        });
    }
    else if (_.isObject(obj)) {
        const keys = _.keys(obj);
        const size = _.size(keys);
        let newObj = obj;
        if (size > OBJ_TOO_BIG) {
            const tKeys = _.take(keys, OBJ_TOO_BIG);
            tKeys.push('TooBig');
            const tValues = _.take(_.values(obj), OBJ_TOO_BIG);
            tValues.push('More ' + (size - OBJ_TOO_BIG) + '.items');
            newObj = new AnyEntity_1.default().toObj(tKeys, tValues);
        }
        return _.mapValues(newObj, (ab) => {
            return autoParse(ab);
        });
    }
    else if (_.isArrayLikeObject(obj)) {
        const size = _.size(obj);
        let newObj = obj;
        if (size > SIZE_TOO_BIG) {
            newObj = _.take(obj, SIZE_TOO_BIG);
            newObj.push({
                TooBig: 'More ' + (size - OBJ_TOO_BIG) + '.items'
            });
        }
        return _.map(newObj, (o) => {
            return autoParse(o);
        });
    }
    else {
        if (_.size(obj) > LOG_TOO_BIG) {
            return '<TOO-BIG-DATA '
                + _.take(obj, LOG_TOO_BIG) + 'More ' + (_.size(obj) - LOG_TOO_BIG) + '.items>';
        }
        return obj;
    }
};
class IocTracer {
    apply(iocData) {
        this.instance.apply(iocData);
    }
    constructor(filters) {
        this.instance = new inversify_tracer_1.InversifyTracer({
            filters: EnumTracerconfig_1.getEnumTracerconfigSetting(filters),
            inspectReturnedPromise: true
        });
        this.instance.on('call', (callInfo) => {
            let parametersWithValue;
            parametersWithValue = callInfo.parameters.map((param) => {
                let m;
                try {
                    m = JSON.stringify(autoParse(param.value));
                }
                catch (_a) {
                    m = '[Circular Json]';
                }
                return `\n  { ${param.name}: ` + m + ' }';
            });
            _log.debug('Call->', `${callInfo.className}.${callInfo.methodName}(`
                + parametersWithValue + '\n);');
        });
        this.instance.on('return', (returnInfo) => {
            if (returnInfo.result instanceof Error) {
                throw returnInfo.result;
            }
            let parametersWithValue;
            try {
                parametersWithValue = JSON.stringify(autoParse(returnInfo.result));
            }
            catch (_a) {
                parametersWithValue = returnInfo.result;
            }
            if (!_.endsWith(returnInfo.className, 'Controller')) {
                _log.debug('Return->', `${returnInfo.className}.${returnInfo.methodName}() => \n  ${parametersWithValue}\n;`);
            }
        });
    }
}
exports.default = IocTracer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW9jVHJhY2VyLmpzIiwic291cmNlUm9vdCI6Ii4vc3JjLyIsInNvdXJjZXMiOlsiaW9jL2lvY1RyYWNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVEQUF5RTtBQUN6RSw0QkFBMEI7QUFJMUIsbUNBQW1DO0FBQ25DLDRCQUE0QjtBQUM1QixpRUFBaUc7QUFDakcsbURBQTRDO0FBQzVDLHFEQUE4QztBQUM5QyxrREFBMkM7QUFFM0MsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUV4QyxNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDdEIsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDO0FBQzNCLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQztBQUN2QixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDeEIsTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFRLEVBQUUsRUFBRTtJQUMzQixJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDakIsT0FBTyxVQUFVO2NBQ1gsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUMsR0FBRyxTQUFTLENBQUM7S0FDdEY7U0FBTSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDeEIsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUNuQixNQUFNLEVBQUUsY0FBYztZQUN0QixRQUFRLEVBQUUsb0JBQW9CO1NBQ2pDLENBQUMsQ0FBQztLQUNOO1NBQU0sSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ3hCLE9BQU8sR0FBRyxDQUFDO0tBQ2Q7U0FBTSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFD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SyxDQUFDLENBQUM7YUFDOUY7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQXhDRCw0QkF3Q0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYWxsSW5mbywgSW52ZXJzaWZ5VHJhY2VyLCBSZXR1cm5JbmZvIH0gZnJvbSAnaW52ZXJzaWZ5LXRyYWNlcic7XG5pbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3VibW9kdWxlLWltcG9ydHNcbmltcG9ydCB7IFBhcmFtZXRlciB9IGZyb20gJ2ludmVyc2lmeS10cmFjZXIvYnVpbGQvcHJveHktbGlzdGVuZXInO1xuaW1wb3J0ICogYXMgbG9nNGpzIGZyb20gJ2tvYS1sb2c0JztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEVudW1UcmFjZXJjb25maWdTZXR0aW5nLCBnZXRFbnVtVHJhY2VyY29uZmlnU2V0dGluZyB9IGZyb20gJy4uL2NvbmZpZy9FbnVtVHJhY2VyY29uZmlnJztcbmltcG9ydCBBbnlFbnRpdHkgZnJvbSAnLi4vbW9kZWxzL0FueUVudGl0eSc7XG5pbXBvcnQgR2FtYUVudGl0eSBmcm9tICcuLi9tb2RlbHMvQmFzZUVudGl0eSc7XG5pbXBvcnQgR2FtYVV0aWxzIGZyb20gJy4uL3V0aWxzL0Jhc2VVdGlscyc7XG5cbmNvbnN0IF9sb2cgPSBsb2c0anMuZ2V0TG9nZ2VyKCdUcmFjZXInKTtcblxuY29uc3QgTE9HX1RPT19CSUcgPSA1O1xuY29uc3QgU1RSSU5HX1RPT19CSUcgPSAxMDA7XG5jb25zdCBPQkpfVE9PX0JJRyA9IDE1O1xuY29uc3QgU0laRV9UT09fQklHID0gMTA7XG5jb25zdCBhdXRvUGFyc2UgPSAob2JqOiBhbnkpID0+IHtcbiAgICBpZiAoXy5pc0J1ZmZlcihvYmopKSB7XG4gICAgICAgIHJldHVybiAnPEJVRkZFUiAnXG4gICAgICAgICAgICArIF8udGFrZShvYmosIExPR19UT09fQklHKSArICdNb3JlICcgKyAoXy5zaXplKG9iaikgLSBMT0dfVE9PX0JJRykgKyAnLml0ZW1zPic7XG4gICAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKG9iaikpIHtcbiAgICAgICAgcmV0dXJuIF8udHJ1bmNhdGUob2JqLCB7XG4gICAgICAgICAgICBsZW5ndGg6IFNUUklOR19UT09fQklHLFxuICAgICAgICAgICAgb21pc3Npb246ICcgPFN0cmluZ1Rvb0JpZy4uLj4nXG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoXy5pc051bWJlcihvYmopKSB7XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgfSBlbHNlIGlmIChfLmlzRGF0ZShvYmopKSB7XG4gICAgICAgIHJldHVybiBHYW1hVXRpbHMuREJUaW1lRm9ybWF0KG9iaik7XG4gICAgfSBlbHNlIGlmIChvYmogaW5zdGFuY2VvZiBHYW1hRW50aXR5KSB7XG4gICAgICAgIHJldHVybiBfLm1hcFZhbHVlcyhvYmoudG9KU09OKCksICh2KSA9PiB7XG4gICAgICAgICAgICBpZiAoXy5pc0J1ZmZlcih2KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnPEJVRkZFUiAnXG4gICAgICAgICAgICAgICAgICAgICsgXy50YWtlKHYsIExPR19UT09fQklHKSArICdNb3JlICcgKyAoXy5zaXplKHYpIC0gTE9HX1RPT19CSUcpICsgJy5pdGVtcz4nO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKHYpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIF8udHJ1bmNhdGUodiwge1xuICAgICAgICAgICAgICAgICAgICBsZW5ndGg6IFNUUklOR19UT09fQklHLFxuICAgICAgICAgICAgICAgICAgICBvbWlzc2lvbjogJyA8U3RyaW5nVG9vQmlnLi4uPidcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc051bWJlcih2KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChfLmlzRGF0ZSh2KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBHYW1hVXRpbHMuREJUaW1lRm9ybWF0KHYpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChfLnNpemUodikgPiBMT0dfVE9PX0JJRykge1xuICAgICAgICAgICAgICAgIHJldHVybiAnPFRPTy1CSUctREFUQSAnXG4gICAgICAgICAgICAgICAgICAgICsgXy50YWtlKHYsIExPR19UT09fQklHKSArICdNb3JlICcgKyAoXy5zaXplKHYpIC0gTE9HX1RPT19CSUcpICsgJy5pdGVtcz4nO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChfLmlzT2JqZWN0KG9iaikpIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IF8ua2V5cyhvYmopO1xuICAgICAgICBjb25zdCBzaXplID0gXy5zaXplKGtleXMpO1xuICAgICAgICBsZXQgbmV3T2JqID0gb2JqO1xuICAgICAgICBpZiAoc2l6ZSA+IE9CSl9UT09fQklHKSB7XG4gICAgICAgICAgICBjb25zdCB0S2V5cyA9IF8udGFrZShrZXlzLCBPQkpfVE9PX0JJRyk7XG4gICAgICAgICAgICB0S2V5cy5wdXNoKCdUb29CaWcnKTtcbiAgICAgICAgICAgIGNvbnN0IHRWYWx1ZXMgPSBfLnRha2UoXy52YWx1ZXMob2JqKSwgT0JKX1RPT19CSUcpO1xuICAgICAgICAgICAgdFZhbHVlcy5wdXNoKCdNb3JlICcgKyAoc2l6ZSAtIE9CSl9UT09fQklHKSArICcuaXRlbXMnKTtcbiAgICAgICAgICAgIG5ld09iaiA9IG5ldyBBbnlFbnRpdHkoKS50b09iaih0S2V5cywgdFZhbHVlcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIF8ubWFwVmFsdWVzKG5ld09iaiwgKGFiKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYXV0b1BhcnNlKGFiKTtcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChfLmlzQXJyYXlMaWtlT2JqZWN0KG9iaikpIHtcbiAgICAgICAgY29uc3Qgc2l6ZSA9IF8uc2l6ZShvYmopO1xuICAgICAgICBsZXQgbmV3T2JqID0gb2JqO1xuICAgICAgICBpZiAoc2l6ZSA+IFNJWkVfVE9PX0JJRykge1xuICAgICAgICAgICAgbmV3T2JqID0gXy50YWtlKG9iaiwgU0laRV9UT09fQklHKTtcbiAgICAgICAgICAgIG5ld09iai5wdXNoKHtcbiAgICAgICAgICAgICAgICBUb29CaWc6ICdNb3JlICcgKyAoc2l6ZSAtIE9CSl9UT09fQklHKSArICcuaXRlbXMnXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gXy5tYXAobmV3T2JqLCAobykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGF1dG9QYXJzZShvKTtcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKF8uc2l6ZShvYmopID4gTE9HX1RPT19CSUcpIHtcbiAgICAgICAgICAgIHJldHVybiAnPFRPTy1CSUctREFUQSAnXG4gICAgICAgICAgICAgICAgKyBfLnRha2Uob2JqLCBMT0dfVE9PX0JJRykgKyAnTW9yZSAnICsgKF8uc2l6ZShvYmopIC0gTE9HX1RPT19CSUcpICsgJy5pdGVtcz4nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgfVxufTtcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIElvY1RyYWNlciB7XG4gICAgcHVibGljIGluc3RhbmNlOiBJbnZlcnNpZnlUcmFjZXI7XG4gICAgcHVibGljIGFwcGx5KGlvY0RhdGEpIHtcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5hcHBseShpb2NEYXRhKTtcbiAgICB9XG4gICAgY29uc3RydWN0b3IoZmlsdGVyczogRW51bVRyYWNlcmNvbmZpZ1NldHRpbmcpIHtcbiAgICAgICAgdGhpcy5pbnN0YW5jZSA9IG5ldyBJbnZlcnNpZnlUcmFjZXIoe1xuICAgICAgICAgICAgZmlsdGVyczogZ2V0RW51bVRyYWNlcmNvbmZpZ1NldHRpbmcoZmlsdGVycyksXG4gICAgICAgICAgICBpbnNwZWN0UmV0dXJuZWRQcm9taXNlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmluc3RhbmNlLm9uKCdjYWxsJywgKGNhbGxJbmZvOiBDYWxsSW5mbykgPT4ge1xuICAgICAgICAgICAgbGV0IHBhcmFtZXRlcnNXaXRoVmFsdWU7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzV2l0aFZhbHVlID0gY2FsbEluZm8ucGFyYW1ldGVycy5tYXAoKHBhcmFtOiBQYXJhbWV0ZXIpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbTtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBtID0gSlNPTi5zdHJpbmdpZnkoYXV0b1BhcnNlKHBhcmFtLnZhbHVlKSk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAgICAgICAgIG0gPSAnW0NpcmN1bGFyIEpzb25dJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGBcXG4gIHsgJHtwYXJhbS5uYW1lfTogYCArIG0gKyAnIH0nO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBfbG9nLmRlYnVnKCdDYWxsLT4nLCBgJHtjYWxsSW5mby5jbGFzc05hbWV9LiR7Y2FsbEluZm8ubWV0aG9kTmFtZX0oYFxuICAgICAgICAgICAgICAgICsgcGFyYW1ldGVyc1dpdGhWYWx1ZSArICdcXG4pOycpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5vbigncmV0dXJuJywgKHJldHVybkluZm86IFJldHVybkluZm8pID0+IHtcbiAgICAgICAgICAgIGlmIChyZXR1cm5JbmZvLnJlc3VsdCBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgcmV0dXJuSW5mby5yZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgcGFyYW1ldGVyc1dpdGhWYWx1ZTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyc1dpdGhWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KGF1dG9QYXJzZShyZXR1cm5JbmZvLnJlc3VsdCkpO1xuICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyc1dpdGhWYWx1ZSA9IHJldHVybkluZm8ucmVzdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFfLmVuZHNXaXRoKHJldHVybkluZm8uY2xhc3NOYW1lLCAnQ29udHJvbGxlcicpKSB7XG4gICAgICAgICAgICAgICAgX2xvZy5kZWJ1ZygnUmV0dXJuLT4nLFxuICAgICAgICAgICAgICAgICAgICBgJHtyZXR1cm5JbmZvLmNsYXNzTmFtZX0uJHtyZXR1cm5JbmZvLm1ldGhvZE5hbWV9KCkgPT4gXFxuICAke3BhcmFtZXRlcnNXaXRoVmFsdWV9XFxuO2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=